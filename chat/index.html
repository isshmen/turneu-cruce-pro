<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Joker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, collection, setDoc, onSnapshot, query, orderBy, limitToLast, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG5193qgq-dNX41yhCgXrl9WFNLhUiNnU",
            authDomain: "turneu-cruce.firebaseapp.com",
            projectId: "turneu-cruce",
            storageBucket: "turneu-cruce.firebasestorage.app",
            messagingSenderId: "169022341825",
            appId: "1:169022341825:web:53678e9ce275654bfe4a40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMINS = ["isshmen@gmail.com", "admin@admin.ro"];
        let userLogat = null;
        let replyTo = null;
        let listaJucatori = [];

        const isAdmin = () => userLogat && ADMINS.includes(userLogat.email);
        const curataNume = (n) => n ? n.replace(/\s*\(.*?\)\s*/g, "").trim() : "Anonim";

        // Cere permisiune notificƒÉri
        window.cerePermisiuneNotificari = () => {
            if ("Notification" in window) {
                Notification.requestPermission().then(p => {
                    if(p === 'granted') alert("NotificƒÉri activate!");
                });
            }
        };

        // Trimite Notificare LocalƒÉ
        const trimiteNotificare = (msg) => {
            if (!userLogat || msg.uid === userLogat.uid) return;
            const numeCurat = curataNume(userLogat.displayName);
            if (msg.text.includes(`@${numeCurat}`) && Notification.permission === "granted") {
                new Notification("Ai fost men»õionat!", { body: `${msg.expeditor}: ${msg.text}`, icon: '/favicon.ico' });
            }
        };

        // LogicƒÉ Autocomplete @
        window.handleTagging = (val) => {
            const index = val.lastIndexOf('@');
            const sugestiiDiv = document.getElementById('sugestiiTag');
            if (index !== -1) {
                const search = val.substring(index + 1).toLowerCase();
                const matches = listaJucatori.filter(n => n.toLowerCase().includes(search)).slice(0, 5);
                
                if (matches.length > 0) {
                    sugestiiDiv.innerHTML = matches.map(n => `<div onclick="aplicaTag('${n}')" class="p-3 hover:bg-blue-600 cursor-pointer border-b border-white/10 text-xs font-bold uppercase">${n}</div>`).join('');
                    sugestiiDiv.classList.remove('hidden');
                    return;
                }
            }
            sugestiiDiv.classList.add('hidden');
        };

        window.aplicaTag = (nume) => {
            const input = document.getElementById('chatInput');
            const index = input.value.lastIndexOf('@');
            input.value = input.value.substring(0, index) + `@${nume} `;
            document.getElementById('sugestiiTag').classList.add('hidden');
            input.focus();
        };

        window.setReply = (id, nume, text) => {
            replyTo = { id, nume, text: text.substring(0, 40) + "..." };
            const bar = document.getElementById('replyBar');
            bar.innerHTML = `<div class="flex justify-between items-center bg-blue-900/40 p-3 text-[10px] border-l-4 border-blue-500 animate-pulse">
                <span class="text-blue-200">RƒÉspuns cƒÉtre <b>${nume}</b>: ${replyTo.text}</span>
                <button onclick="cancelReply()" class="text-white bg-red-500 rounded-full w-4 h-4 flex items-center justify-center text-[8px] font-black">X</button>
            </div>`;
            document.getElementById('chatInput').focus();
        };

        window.cancelReply = () => { replyTo = null; document.getElementById('replyBar').innerHTML = ""; };

        window.trimiteMesaj = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !userLogat) return;

            await setDoc(doc(collection(db, "chat")), {
                text: text, expeditor: curataNume(userLogat.displayName),
                uid: userLogat.uid, timestamp: Date.now(), tip: 'user',
                reply: replyTo, esteAdmin: isAdmin()
            });
            input.value = "";
            cancelReply();
        };

        window.editeazaMesaj = async (id, uid, textVechi) => {
            if (userLogat.uid !== uid && !isAdmin()) return;
            const noulText = prompt("EditeazƒÉ mesajul:", textVechi);
            if (noulText && noulText !== textVechi) {
                await updateDoc(doc(db, "chat", id), { text: noulText, editat: true });
            }
        };

        window.stergeMesaj = async (id) => {
            if (!isAdmin()) return;
            if (confirm("»òtergi mesajul?")) await updateDoc(doc(db, "chat", id), { sters: true });
        };

        onAuthStateChanged(auth, async (u) => {
            userLogat = u;
            // LuƒÉm lista de jucƒÉtori pentru @
            const s = await getDoc(doc(db, "setari", "turnee"));
            if(s.exists()) listaJucatori = s.data().inscrisi_JOKER || [];

            const q = query(collection(db, "chat"), orderBy("timestamp", "asc"), limitToLast(50));
            onSnapshot(q, (snapshot) => {
                const chatContainer = document.getElementById('chatContainer');
                let html = "";
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") trimiteNotificare(change.doc.data());
                });

                snapshot.forEach((d) => {
                    const m = d.data(); if (m.sters) return;
                    const esteSistem = m.tip === 'sistem', esteEu = m.uid === userLogat?.uid, esteAdminMsg = m.esteAdmin === true;
                    const ora = new Date(m.timestamp).toLocaleTimeString('ro-RO', { hour: '2-digit', minute: '2-digit' });

                    if (esteSistem) {
                        html += `<div class="bg-blue-900/10 border border-blue-500/20 p-3 rounded-xl text-center my-4 group relative">
                            <p class="text-[10px] font-bold text-blue-400 uppercase italic">üì¢ ${m.text}</p>
                            <span class="text-[8px] text-slate-600 block mt-1">${ora}</span>
                        </div>`;
                    } else {
                        const colNume = esteAdminMsg ? 'text-green-500' : 'text-slate-500';
                        const colBula = esteAdminMsg ? 'border border-green-500/30 bg-green-900/20' : (esteEu ? 'bg-blue-600' : 'bg-slate-800');
                        html += `<div class="flex flex-col ${esteEu ? 'items-end' : 'items-start'} mb-4 group">
                            <div class="flex items-center gap-2 mb-1 px-2 text-[8px] font-black uppercase ${colNume}">
                                <span>${m.expeditor} ‚Ä¢ ${ora}</span>
                                <button onclick="setReply('${d.id}', '${m.expeditor}', '${m.text}')" class="hidden group-hover:inline text-slate-400">Reply</button>
                                ${(esteEu || isAdmin()) ? `<button onclick="editeazaMesaj('${d.id}', '${m.uid}', '${m.text}')" class="hidden group-hover:inline text-blue-500">Edit</button>` : ''}
                                ${isAdmin() ? `<button onclick="stergeMesaj('${d.id}')" class="text-red-500">X</button>` : ''}
                            </div>
                            <div class="${colBula} px-4 py-2 rounded-2xl max-w-[85%] text-sm shadow-lg relative">
                                ${m.reply ? `<div class="text-[9px] opacity-60 border-l-2 border-white/30 pl-2 mb-2 italic bg-black/20 p-1 rounded">@${m.reply.nume}: ${m.reply.text}</div>` : ''}
                                <div class="${esteAdminMsg ? 'text-green-400' : 'text-white'}">${m.text.replace(/@([a-zA-ZƒÇ√Ç√é≈û≈¢ƒÉ√¢√Æ≈ü≈£\s]+)/g, '<b class="text-yellow-400">@$1</b>')}</div>
                                ${m.editat ? `<span class="text-[7px] opacity-30 block mt-1 italic font-bold">EDITAT</span>` : ''}
                            </div>
                        </div>`;
                    }
                });
                chatContainer.innerHTML = html;
                chatContainer.scrollTop = chatContainer.scrollHeight;
                document.getElementById('inputZona').style.display = userLogat ? 'flex' : 'none';
            });
        });
    </script>
</head>
<body class="bg-black text-slate-300 font-sans p-4">
    <div class="max-w-2xl mx-auto min-h-screen flex flex-col">
        <div class="flex-1">
            <div class="flex justify-between items-center mb-6">
                <a href="/" class="bg-green-600 text-white px-6 py-3 rounded-xl font-black uppercase text-[10px] shadow-lg">‚Üê AcasƒÉ</a>
                <button onclick="cerePermisiuneNotificari()" class="bg-slate-800 text-[9px] font-black uppercase px-4 py-3 rounded-xl text-slate-400">üîî NotificƒÉri</button>
            </div>
            
            <div class="bg-slate-900 rounded-[2.5rem] border border-slate-800 flex flex-col h-[70vh] overflow-hidden shadow-2xl relative">
                <div class="p-6 border-b border-slate-800 bg-black/20 text-center">
                    <h3 class="text-xl font-black italic uppercase text-white tracking-widest">Chat & Activitate</h3>
                </div>
                
                <div id="chatContainer" class="flex-1 overflow-y-auto p-6 scroll-smooth flex flex-col"></div>

                <div id="replyBar"></div>
                <div id="sugestiiTag" class="hidden absolute bottom-20 left-4 right-4 bg-slate-800 border border-blue-500 rounded-xl shadow-2xl z-50 overflow-hidden"></div>

                <form id="inputZona" onsubmit="trimiteMesaj(event)" class="p-4 bg-black/40 border-t border-slate-800 flex gap-2" style="display: none;">
                    <input type="text" id="chatInput" autocomplete="off" oninput="handleTagging(this.value)" placeholder="Mesaj... (@nume)" class="flex-1 bg-slate-900 border border-slate-800 p-4 rounded-xl text-white text-sm outline-none focus:border-blue-500 transition-all">
                    <button class="bg-blue-600 text-white px-6 rounded-xl font-black uppercase text-[10px]">Trimite</button>
                </form>
            </div>
        </div>

        <footer class="mt-10 py-10 border-t border-slate-900 text-center">
            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-600 px-4"> 
                &copy; 2026. Creat de <a href="https://www.facebook.com/isshmenn" target="_blank" class="text-blue-500 hover:text-blue-400">Vali Dragomir</a>. Poti sustine proiectul cu o donatie pe <a href="http://revolut.me/isshmen" target="_blank" class="text-blue-500 hover:text-blue-400">Revolut</a>
            </p>
        </footer>
    </div>
</body>
</html>
