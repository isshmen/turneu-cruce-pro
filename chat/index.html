<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Joker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, collection, setDoc, onSnapshot, query, orderBy, limitToLast, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG5193qgq-dNX41yhCgXrl9WFNLhUiNnU",
            authDomain: "turneu-cruce.firebaseapp.com",
            projectId: "turneu-cruce",
            storageBucket: "turneu-cruce.appspot.com",
            messagingSenderId: "169022341825",
            appId: "1:169022341825:web:53678e9ce275654bfe4a40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let userLogat = null;
        let listaJucatori = [];

        // --- FUNC»öII UTILS ---
        const extractYTId = (url) => {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length == 11) ? match[7] : false;
        };

        const optimizeImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > 1000) { height *= 1000 / width; width = 1000; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.7);
                    };
                };
            });
        };

        // --- ACTIONS ---
        window.handleFileUpload = async (e) => {
            const file = e.target.files[0];
            if (!file || !userLogat) return;
            
            const btn = document.getElementById('btnUpload');
            btn.innerHTML = "‚è≥";
            
            const optimizedBlob = await optimizeImage(file);
            const fileName = `chat/${Date.now()}_${userLogat.uid}.jpg`;
            const storageRef = ref(storage, fileName);
            
            await uploadBytes(storageRef, optimizedBlob);
            const url = await getDownloadURL(storageRef);
            
            await setDoc(doc(collection(db, "chat")), {
                text: "", expeditor: userLogat.displayName, uid: userLogat.uid,
                timestamp: Date.now(), tip: 'user', mediaUrl: url
            });
            btn.innerHTML = "üì∑";
        };

        window.trimiteMesaj = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !userLogat) return;

            const ytId = extractYTId(text);
            await setDoc(doc(collection(db, "chat")), {
                text: text, expeditor: userLogat.displayName, uid: userLogat.uid,
                timestamp: Date.now(), tip: 'user', ytId: ytId || null
            });
            input.value = "";
        };

        // --- RENDER ---
        onAuthStateChanged(auth, (u) => {
            userLogat = u;
            const q = query(collection(db, "chat"), orderBy("timestamp", "asc"), limitToLast(30));
            onSnapshot(q, (snaps) => {
                const container = document.getElementById('chatContainer');
                let html = "";
                snaps.forEach(d => {
                    const m = d.data();
                    const esteEu = m.uid === userLogat?.uid;
                    const ora = new Date(m.timestamp).toLocaleTimeString('ro-RO', {hour:'2-digit', minute:'2-digit'});

                    html += `<div class="flex flex-col ${esteEu ? 'items-end' : 'items-start'} mb-4">
                        <span class="text-[8px] uppercase text-slate-500 mb-1">${m.expeditor} ‚Ä¢ ${ora}</span>
                        <div class="${esteEu ? 'bg-blue-600' : 'bg-slate-800'} p-3 rounded-2xl max-w-[85%] shadow-lg">
                            ${m.text ? `<p class="text-sm text-white">${m.text}</p>` : ''}
                            ${m.mediaUrl ? `<img src="${m.mediaUrl}" onclick="window.open('${m.mediaUrl}')" class="rounded-lg mt-1 max-w-[200px] cursor-pointer hover:opacity-80">` : ''}
                            ${m.ytId ? `<div class="mt-2 rounded-lg overflow-hidden border border-white/10">
                                <iframe width="100%" height="150" src="https://www.youtube.com/embed/${m.ytId}" frameborder="0" allowfullscreen></iframe>
                            </div>` : ''}
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
                container.scrollTop = container.scrollHeight;
                document.getElementById('inputZona').style.display = userLogat ? 'flex' : 'none';
            });
        });
    </script>
</head>
<body class="bg-black text-slate-300 p-4">
    <div class="max-w-2xl mx-auto flex flex-col h-screen">
        <a href="/" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs mb-4 inline-block w-fit">‚Üê AcasƒÉ</a>
        
        <div class="bg-slate-900 rounded-3xl border border-slate-800 flex flex-col flex-1 overflow-hidden">
            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 flex flex-col"></div>
            
            <form id="inputZona" onsubmit="trimiteMesaj(event)" class="p-4 bg-black/40 border-t border-slate-800 flex items-center gap-2" style="display:none">
                <label id="btnUpload" class="cursor-pointer bg-slate-800 w-12 h-12 flex items-center justify-center rounded-xl hover:bg-slate-700">
                    üì∑ <input type="file" accept="image/*" class="hidden" onchange="handleFileUpload(e)">
                </label>
                <input type="text" id="chatInput" placeholder="Mesaj sau link YT..." class="flex-1 bg-slate-900 border-none p-4 rounded-xl text-white outline-none">
                <button class="bg-blue-600 p-4 rounded-xl font-bold">></button>
            </form>
        </div>
        
        <footer class="py-6 text-center text-[10px] text-slate-600 uppercase tracking-widest">
            &copy; 2026 Creat de Vali Dragomir
        </footer>
    </div>
</body>
</html>
