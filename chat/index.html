<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Joker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, collection, setDoc, onSnapshot, query, orderBy, limitToLast, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG5193qgq-dNX41yhCgXrl9WFNLhUiNnU",
            authDomain: "turneu-cruce.firebaseapp.com",
            projectId: "turneu-cruce",
            storageBucket: "turneu-cruce.firebasestorage.app",
            messagingSenderId: "169022341825",
            appId: "1:169022341825:web:53678e9ce275654bfe4a40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMINS = ["isshmen@gmail.com", "admin@admin.ro"];
        const IMGBB_API = "3fead71bfe9e9a00daee5948cb94fdf3";
        let userLogat = null;
        let replyTo = null;
        let listaJucatori = [];
        let primaIncarcare = true;

        const isAdmin = () => userLogat && ADMINS.includes(userLogat.email);
        const curataNume = (n) => n ? n.replace(/\s*\(.*?\)\s*/g, "").trim() : "Anonim";

        window.activeazaNotificari = () => {
            Notification.requestPermission().then(perm => { if (perm === "granted") alert("NotificÄƒri activate!"); });
        };

        const trimiteNotificare = (titlu, msg) => {
            if (Notification.permission === "granted" && !primaIncarcare) {
                new Notification(titlu, { body: msg });
            }
        };

        const extractYTId = (t) => {
            const match = t.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);
            return (match && match[7].length == 11) ? match[7] : false;
        };

        window.stergeMesaj = async (id) => { if (confirm("È˜tergi?")) await deleteDoc(doc(db, "chat", id)); };
        window.editeazaMesaj = async (id, textVechi) => {
            const nouText = prompt("EditeazÄƒ:", textVechi);
            if (nouText && nouText !== textVechi) await updateDoc(doc(db, "chat", id), { text: nouText, editat: true });
        };

        window.handleFileUpload = async (event) => {
            const file = event.target.files[0];
            if (!file || !userLogat) return;
            const btn = document.getElementById('btnUpload');
            btn.innerHTML = "â³";
            try {
                const formData = new FormData();
                formData.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API}`, { method: "POST", body: formData });
                const data = await res.json();
                if (data.success) {
                    await setDoc(doc(collection(db, "chat")), {
                        text: "", expeditor: curataNume(userLogat.displayName),
                        uid: userLogat.uid, timestamp: Date.now(), tip: 'user',
                        mediaUrl: data.data.url, thumbUrl: data.data.thumb.url
                    });
                }
            } catch (err) { alert("Eroare upload!"); }
            btn.innerHTML = "ğŸ“·";
        };

        window.trimiteMesaj = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !userLogat) return;
            await setDoc(doc(collection(db, "chat")), {
                text: text, expeditor: curataNume(userLogat.displayName),
                uid: userLogat.uid, timestamp: Date.now(), tip: 'user',
                reply: replyTo, esteAdmin: isAdmin(), ytId: extractYTId(text)
            });
            input.value = ""; window.cancelReply();
        };

        window.handleTagging = (val) => {
            const idx = val.lastIndexOf('@');
            const div = document.getElementById('sugestiiTag');
            if (idx !== -1) {
                const s = val.substring(idx + 1).toLowerCase();
                const matches = listaJucatori.filter(n => n.toLowerCase().includes(s)).slice(0, 5);
                if (matches.length > 0) {
                    div.innerHTML = matches.map(n => `<div onclick="aplicaTag('${n}')" class="p-3 hover:bg-blue-600 cursor-pointer border-b border-white/10 text-xs font-bold uppercase">${n}</div>`).join('');
                    div.classList.remove('hidden'); return;
                }
            }
            div.classList.add('hidden');
        };

        window.aplicaTag = (n) => {
            const i = document.getElementById('chatInput');
            i.value = i.value.substring(0, i.value.lastIndexOf('@')) + `@${n} `;
            document.getElementById('sugestiiTag').classList.add('hidden'); i.focus();
        };

        window.setReply = (id, nume, text) => {
            replyTo = { id, nume, text: text.substring(0, 30) + "..." };
            document.getElementById('replyBar').innerHTML = `<div class="flex justify-between items-center bg-blue-900/40 p-3 text-[10px] border-l-4 border-blue-500"><span class="text-blue-200">RÄƒspuns cÄƒtre <b>${nume}</b></span><button onclick="cancelReply()" class="bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center font-black">X</button></div>`;
            document.getElementById('chatInput').focus();
        };
        window.cancelReply = () => { replyTo = null; document.getElementById('replyBar').innerHTML = ""; };

        onAuthStateChanged(auth, async (u) => {
            userLogat = u;
            const s = await getDoc(doc(db, "setari", "turnee"));
            if(s.exists()) listaJucatori = [...new Set((s.data().inscrisi_JOKER || []).flatMap(e => e.split(/[&+/]/).map(n => n.trim())))];

            onSnapshot(query(collection(db, "chat"), orderBy("timestamp", "asc"), limitToLast(50)), (snap) => {
                let html = "";
                snap.forEach(d => {
                    const m = d.data(), id = d.id;
                    const esteEu = m.uid === userLogat?.uid, esteAdminMsg = m.esteAdmin === true;
                    const ora = new Date(m.timestamp).toLocaleTimeString('ro-RO', {hour:'2-digit', minute:'2-digit'});
                    
                    if (m.tip === 'sistem') {
                        html += `<div class="group relative bg-blue-900/10 border border-blue-500/20 p-3 rounded-xl text-center my-4 text-[10px] font-bold text-blue-400 uppercase">ğŸ“¢ ${m.text} ${isAdmin() ? `<button onclick="stergeMesaj('${id}')" class="ml-2 text-red-500 opacity-0 group-hover:opacity-100">X</button>` : ''}</div>`;
                    } else {
                        const colNume = esteAdminMsg ? 'text-green-500' : 'text-slate-500';
                        const colBula = esteAdminMsg ? 'border border-green-500/30 bg-green-900/20' : (esteEu ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-100');
                        html += `<div class="flex flex-col ${esteEu ? 'items-end' : 'items-start'} mb-4 group">
                            <div class="flex items-center gap-3 mb-1 px-2 text-[8px] font-black uppercase ${colNume}">
                                <span>${m.expeditor} â€¢ ${ora} ${m.editat ? '(editat)' : ''}</span>
                                <div class="opacity-0 group-hover:opacity-100 flex gap-2">
                                    <button onclick="setReply('${id}', '${m.expeditor}', '${m.text}')" class="text-slate-400">Reply</button>
                                    ${esteEu ? `<button onclick="editeazaMesaj('${id}', '${m.text}')" class="text-blue-400">Edit</button>` : ''}
                                    ${(esteEu || isAdmin()) ? `<button onclick="stergeMesaj('${id}')" class="text-red-500">È˜terge</button>` : ''}
                                </div>
                            </div>
                            <div class="${colBula} px-4 py-2 rounded-2xl max-w-[85%] text-sm shadow-lg">
                                ${m.reply ? `<div class="text-[9px] opacity-60 border-l-2 border-white/30 pl-2 mb-2 italic bg-black/20 p-1 rounded">@${m.reply.nume}: ${m.reply.text}</div>` : ''}
                                ${m.text ? `<div>${m.text.replace(/@([a-zA-ZÄ‚Ã‚ÃÅÅ¢ÄƒÃ¢Ã®ÅŸÅ£\s\-]+)(?=\s|$)/g, '<b class="text-yellow-400">@$1</b>')}</div>` : ''}
                                ${m.mediaUrl ? `<img src="${m.thumbUrl || m.mediaUrl}" onclick="window.open('${m.mediaUrl}')" class="rounded-lg mt-2 max-w-full cursor-pointer">` : ''}
                                ${m.ytId ? `<div class="mt-2 rounded-lg overflow-hidden border border-white/10"><iframe width="100%" height="180" src="https://www.youtube.com/embed/${m.ytId}" frameborder="0" allowfullscreen></iframe></div>` : ''}
                            </div>
                        </div>`;
                    }
                });
                const c = document.getElementById('chatContainer'); c.innerHTML = html; c.scrollTop = c.scrollHeight;
                if (!primaIncarcare && snap.docChanges().some(c => c.type === "added")) {
                    const nou = snap.docs[snap.docs.length-1].data();
                    if (nou.uid !== userLogat?.uid) trimiteNotificare(nou.expeditor || "Sistem", nou.text || "Mesaj nou");
                }
                primaIncarcare = false;
                document.getElementById('inputZona').style.display = userLogat ? 'flex' : 'none';
            });
        });
    </script>
</head>
<body class="bg-black text-slate-300 font-sans p-4">
    <div class="max-w-2xl mx-auto min-h-screen flex flex-col relative">
        <div class="flex justify-between items-center mb-6">
            <a href="/" class="bg-green-600 text-white px-6 py-3 rounded-xl font-black uppercase text-[10px] shadow-lg">â† AcasÄƒ</a>
            <button onclick="activeazaNotificari()" class="bg-slate-800 text-slate-400 px-4 py-3 rounded-xl font-black uppercase text-[10px]">ğŸ”” NotificÄƒri</button>
        </div>
        <div class="bg-slate-900 rounded-[2.5rem] border border-slate-800 flex flex-col h-[75vh] overflow-hidden shadow-2xl relative">
            <div class="p-4 border-b border-slate-800 bg-black/20 text-center uppercase font-black italic text-white tracking-widest">Chat & Activitate</div>
            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 scroll-smooth flex flex-col"></div>
            <div id="replyBar"></div>
            <div id="sugestiiTag" class="hidden absolute bottom-20 left-4 right-4 bg-slate-800 border border-blue-500 rounded-xl z-50 shadow-2xl"></div>
            <form id="inputZona" onsubmit="trimiteMesaj(event)" class="p-3 bg-black/40 border-t border-slate-800 flex items-center gap-2">
                <label id="btnUpload" class="cursor-pointer bg-slate-800 w-12 h-12 flex items-center justify-center rounded-xl">ğŸ“·<input type="file" accept="image/*" class="hidden" onchange="handleFileUpload(event)"></label>
                <input type="text" id="chatInput" autocomplete="off" oninput="handleTagging(this.value)" placeholder="Mesaj..." class="flex-1 bg-slate-900 border border-slate-800 p-3 rounded-xl text-white text-sm outline-none">
                <button class="bg-blue-600 text-white px-5 h-12 rounded-xl font-black uppercase text-[10px]">></button>
            </form>
        </div>
    </div>
</body>
</html>
