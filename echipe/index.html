<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Best Teams #2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG5193qgq-dNX41yhCgXrl9WFNLhUiNnU",
            authDomain: "turneu-cruce.firebaseapp.com",
            projectId: "turneu-cruce",
            storageBucket: "turneu-cruce.firebasestorage.app",
            messagingSenderId: "169022341825",
            appId: "1:169022341825:web:53678e9ce275654bfe4a40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const SEZON_ID = "JOKER_TEAM_2";
        const ADMINS = ["isshmen@gmail.com", "admin@admin.ro"];
        let userLogat = null, currentSezonData = null;
        let state = { pagina: "home", idGrupa: null, faza: "f1" };

        const isAdmin = () => userLogat && ADMINS.includes(userLogat.email);

        window.loginAdmin = async () => {
            const email = prompt("Email:", "admin@admin.ro");
            const pass = prompt("Parolă:");
            if (email && pass) {
                try { await signInWithEmailAndPassword(auth, email, pass); } 
                catch (e) { alert("Autentificare eșuată!"); }
            }
        };

        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);
        window.nav = (p, g = null, f = "f1") => { state = { ...state, pagina: p, idGrupa: g, faza: f }; render(); };

        window.initSezon2 = async () => {
            if (!isAdmin()) return;
            const structura = {
                "1": ["Florian Lile si Maria Cherebet", "Andreea Deea si Galbenusa Aura", "Bobby Tiberiu si Coman Iuliu", "Ancuta Ilies si Ionut Doicar"],
                "2": ["Botos Marius si Paunita Bran", "Vasy Ignat si Ionut Raul", "Roxana Nani si Adina Goman", "Iosif Ghimboasa si Dan Marius"],
                "3": ["Vlad Tino si Cami Alessia", "Adi Ignat si Ancuta Sacota", "Ionel Muntean si Andreea Tontea", "Jozsef Zsolt si Mihai Lungu"],
                "4": ["Andrey Mato si Ioana Cioanca", "Carina Luca si Julia K", "Cristian Patrut si Florin Ginsca", "Nicoleta Ghiata si Livia Holdis"]
            };

            let f1 = {};
            Object.keys(structura).forEach(gk => {
                const p = structura[gk];
                let meciuri = [];
                for (let i = 0; i < p.length; i++) {
                    for (let j = i + 1; j < p.length; j++) {
                        meciuri.push({ id: `m2_${gk}_${i}${j}`, p1: p[i], p2: p[j], s1t: 0, s2t: 0, s1r: 0, s2r: 0, gata: false });
                    }
                }
                f1[gk] = { participanti: p, meciuri: meciuri };
            });

            await setDoc(doc(db, "sezoane", SEZON_ID), { f1, status: 'activ', fazaCurenta: 'f1' });
            alert("Sezonul 2 a fost inițializat!");
        };

        const calculeazaClasament = (g) => {
            if (!g) return [];
            let st = {};
            g.participanti.forEach(p => st[p] = { v: 0, c: 0, p: 0, nume: p });
            g.meciuri.forEach(m => {
                if (!m.gata) return;
                [{ s1: m.s1t, s2: m.s2t }, { s1: m.s1r, s2: m.s2r }].forEach(s => {
                    if (s.s1 > s.s2) st[m.p1].v++; else if (s.s2 > s.s1) st[m.p2].v++;
                    st[m.p1].c += s.s1; st[m.p1].p += s.s2; st[m.p2].c += s.s2; st[m.p2].p += s.s1;
                });
            });
            return Object.values(st).sort((a, b) => b.v - a.v || b.c - a.c || a.p - b.p);
        };

        window.updateScor = async (mId, set, p1, p2, ref) => {
            if (!isAdmin()) return;
            const val = prompt("Scor (ex: 2-0):");
            if (!val) return;
            const [v1, v2] = val.split("-").map(Number);
            let data = { ...currentSezonData };
            let meci = data[state.faza][state.idGrupa].meciuri.find(m => m.id === mId);
            if (ref === p1) { meci[`s1${set}`] = v1; meci[`s2${set}`] = v2; }
            else { meci[`s1${set}`] = v2; meci[`s2${set}`] = v1; }
            meci.gata = true;
            await updateDoc(doc(db, "sezoane", SEZON_ID), data);
        };

        async function render() {
            const root = document.getElementById('app');
            let html = `<div class="max-w-3xl mx-auto p-4 text-white min-h-screen">
                <nav class="flex justify-between items-center mb-10 border-b border-slate-800 pb-6">
                    <h1 onclick="nav('home')" class="font-black text-2xl cursor-pointer italic uppercase">Best Teams <span class="text-blue-500">#2</span></h1>
                    <div class="flex gap-2">
                        ${isAdmin() && !currentSezonData ? `<button onclick="initSezon2()" class="text-[8px] bg-red-600 px-2 py-1 rounded">START SEZON 2</button>` : ''}
                        ${userLogat ? `<button onclick="logout()" class="text-[10px] text-red-500 font-bold uppercase">Ieșire</button>` : `<button onclick="loginAdmin()" class="text-[10px] text-slate-500 font-bold uppercase">Admin Login</button>`}
                    </div>
                </nav>`;

            if (!userLogat) {
                html += `<div class="text-center py-20"><button onclick="loginGoogle()" class="bg-white text-black px-8 py-4 rounded-2xl font-black uppercase text-xs shadow-xl">Conectare Google</button></div>`;
            } else if (state.pagina === "home") {
                if (currentSezonData?.f1) {
                    html += `<div class="grid grid-cols-2 gap-4">`;
                    Object.keys(currentSezonData.f1).sort().forEach(gk => {
                        html += `<div onclick="nav('grupa', '${gk}')" class="bg-slate-900 p-10 rounded-[2.5rem] border border-slate-800 text-center cursor-pointer hover:border-blue-500 transition-all shadow-2xl">
                            <div class="text-[10px] font-black text-slate-500 mb-2 tracking-widest uppercase">Grupa</div>
                            <div class="text-5xl font-black italic">${gk}</div>
                        </div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="text-center text-slate-500 py-10">Așteptare inițializare sezon...</div>`;
                }
            } else if (state.pagina === "grupa") {
                const g = currentSezonData[state.faza][state.idGrupa], c = calculeazaClasament(g);
                html += `<button onclick="nav('home')" class="mb-6 text-[10px] font-black uppercase text-blue-500">← Înapoi</button>
                         <h2 class="text-3xl font-black mb-8 text-center italic uppercase">Grupa ${state.idGrupa}</h2>
                         <div class="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 mb-10 overflow-x-auto">
                            <table class="w-full text-[11px] font-bold">
                                <tr class="text-slate-500 uppercase"><th class="text-left pb-4">Echipă</th><th class="text-center">V</th><th class="text-center">P+</th><th class="text-right">P-</th></tr>
                                ${c.map(x => `<tr class="border-t border-white/5"><td class="py-4 uppercase italic text-blue-400">${x.nume}</td><td class="text-center text-white">${x.v}</td><td class="text-center">${x.c}</td><td class="text-right text-slate-500">${x.p}</td></tr>`).join('')}
                            </table>
                         </div>`;
                g.participanti.forEach(j => {
                    html += `<div class="mb-8"><div class="text-xs font-black uppercase mb-4 text-slate-400 tracking-tighter border-l-2 border-blue-500 pl-2">${j}</div>`;
                    g.meciuri.filter(m => m.p1 === j || m.p2 === j).forEach(m => {
                        const adv = m.p1 === j ? m.p2 : m.p1;
                        const sT = m.p1 === j ? `${m.s1t}-${m.s2t}` : `${m.s2t}-${m.s1t}`;
                        const sR = m.p1 === j ? `${m.s1r}-${m.s2r}` : `${m.s2r}-${m.s1r}`;
                        html += `<div class="bg-slate-900/40 p-4 rounded-2xl border border-white/5 flex justify-between items-center mb-2">
                            <div class="text-[9px] font-bold uppercase italic text-slate-500">vs ${adv}</div>
                            <div class="flex gap-2">
                                <button onclick="updateScor('${m.id}','t','${m.p1}','${m.p2}','${j}')" class="bg-black border border-slate-800 px-4 py-2 rounded-xl text-[10px] font-black">T: ${sT}</button>
                                <button onclick="updateScor('${m.id}','r','${m.p1}','${m.p2}','${j}')" class="bg-black border border-slate-800 px-4 py-2 rounded-xl text-[10px] font-black">R: ${sR}</button>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                });
            }
            root.innerHTML = html + `</div>`;
        }

        onAuthStateChanged(auth, u => { userLogat = u; render(); });
        onSnapshot(doc(db, "sezoane", SEZON_ID), s => { if (s.exists()) { currentSezonData = s.data(); render(); } });
    </script>
</head>
<body class="bg-black font-sans tracking-tight"><div id="app"></div></body>
</html>
