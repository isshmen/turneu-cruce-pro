<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turneu Joker - Single</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG5193qgq-dNX41yhCgXrl9WFNLhUiNnU",
            authDomain: "turneu-cruce.firebaseapp.com",
            projectId: "turneu-cruce",
            storageBucket: "turneu-cruce.firebasestorage.app",
            messagingSenderId: "169022341825",
            appId: "1:169022341825:web:53678e9ce275654bfe4a40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const ADMINS = ["isshmen@gmail.com", "testing@gmail.com"];
        let userLogat = null;
        let globalData = { ed_JOKER: 1, inscrisi_JOKER: [] };
        let currentSezonData = null;
        let state = { pagina: "home", idGrupa: null, faza: "f1", manualGrupe: {}, search: "" };

        const isAdmin = () => userLogat && ADMINS.includes(userLogat.email);
        const curataNume = (n) => n ? n.replace(/\s*\(.*?\)\s*/g, "").trim() : "";

        window.nav = (p, g=null, f="f1") => { state = { ...state, pagina:p, idGrupa:g, faza:f }; render(); };
        window.handleSearch = (val) => { state.search = val.toLowerCase(); render(); };
        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        const calculeazaClasament = (g) => {
            if (!g) return [];
            let st = {};
            g.participanti.forEach(p => st[p] = { victorii: 0, castigate: 0, pierdute: 0, nume: p });
            g.meciuri.forEach(m => {
                if(!m.gata) return;
                [{s1: m.s1t, s2: m.s2t}, {s1: m.s1r, s2: m.s2r}].forEach(s => {
                    if(s.s1 > s.s2) st[m.p1].victorii += 1; 
                    else if(s.s2 > s.s1) st[m.p2].victorii += 1;
                    st[m.p1].castigate += s.s1; st[m.p1].pierdute += s.s2;
                    st[m.p2].castigate += s.s2; st[m.p2].pierdute += s.s1;
                });
            });
            return Object.values(st).sort((a,b) => (b.victorii - a.victorii) || (b.castigate - a.castigate) || (a.pierdute - b.pierdute));
        };

        window.updateScorMeci = async (faza, mId, set) => {
            if(!isAdmin()) return;
            const val = prompt(`Scor (ex: 2-1):`);
            if(!val) return;
            let [va, vb] = val.split("-").map(Number);
            let data = {...currentSezonData};
            let meci = faza === 'f1' ? data.f1[state.idGrupa].meciuri.find(m => m.id === mId) : data.f2[state.idGrupa].meciuri.find(m => m.id === mId);
            meci[`s1${set}`] = va; meci[`s2${set}`] = vb; meci.gata = true;
            await updateDoc(doc(db, "sezoane", `JOKER_${globalData.ed_JOKER}`), data);
        };

        window.atribuiGrupaManual = (n, v) => { state.manualGrupe[n] = v; render(); };

        window.adminStartSezon = async () => {
            const ed = globalData.ed_JOKER;
            const inscrisi = globalData.inscrisi_JOKER;
            let f1 = {};
            const gList = [...new Set(Object.values(state.manualGrupe))].filter(v => v !== "");
            gList.forEach((gk) => {
                const p = inscrisi.filter(n => state.manualGrupe[n] === gk);
                if(p.length > 0) {
                    f1[gk] = { participanti: p, meciuri: [] };
                    for(let i=0; i<p.length; i++) for(let j=i+1; j<p.length; j++) 
                        f1[gk].meciuri.push({ id: "M-"+Math.random().toString(36).substr(2,9), p1: p[i], p2: p[j], s1t:0, s2t:0, s1r:0, s2r:0, gata: false });
                }
            });
            await setDoc(doc(db, "sezoane", `JOKER_${ed}`), { f1, status: 'activ', fazaCurenta: 'f1' });
        };

        window.generaFazaUrmatoare = async () => {
            if(!confirm("Generezi Faza 2 (Cele 4 Grupe Noi)?")) return;
            const data = {...currentSezonData};
            const c = {};
            Object.keys(data.f1).forEach(gk => { c[gk] = calculeazaClasament(data.f1[gk]); });

            const mMeci = (p1, p2) => ({ id: "M2-"+Math.random().toString(36).substr(2,9), p1, p2, s1t:0, s2t:0, s1r:0, s2r:0, gata: false });

            const structuraF2 = {
                "1": [ ['A',0], ['B',1], ['C',0], ['D',1] ],
                "2": [ ['B',0], ['A',1], ['D',0], ['C',1] ],
                "3": [ ['E',0], ['F',1], ['G',0], ['H',1] ],
                "4": [ ['F',0], ['E',1], ['H',0], ['G',1] ]
            };

            data.f2 = {};
            Object.entries(structuraF2).forEach(([numarGrupa, reguli]) => {
                const participanti = reguli.map(r => c[r[0]]?.[r[1]]?.nume).filter(n => n);
                if(participanti.length > 0) {
                    data.f2[numarGrupa] = { participanti, meciuri: [] };
                    for(let i=0; i<participanti.length; i++) {
                        for(let j=i+1; j<participanti.length; j++) {
                            data.f2[numarGrupa].meciuri.push(mMeci(participanti[i], participanti[j]));
                        }
                    }
                }
            });

            data.fazaCurenta = 'f2';
            await updateDoc(doc(db, "sezoane", `JOKER_${globalData.ed_JOKER}`), data);
        };

        async function render() {
            const root = document.getElementById('app');
            const curSezon = currentSezonData;
            const ed = globalData.ed_JOKER;

            let html = `<div class="max-w-2xl mx-auto p-4"><nav class="flex justify-between items-center mb-10 border-b border-slate-800 pb-6">
                <h1 onclick="nav('home')" class="font-black text-3xl cursor-pointer text-white uppercase italic">Joker<span class="text-blue-500 ml-1">#${ed}</span></h1>
                <div id="auth-ui" class="text-[10px] font-black uppercase"></div></nav>`;

            if(!userLogat) {
                html += `<button onclick="loginGoogle()" class="w-full bg-white text-black py-4 rounded-xl font-black uppercase text-xs">Google Login</button>`;
            } else if(state.pagina === "home") {
                if(!curSezon) {
                    const inscrisi = globalData.inscrisi_JOKER || [];
                    html += `<div class="bg-slate-900 p-8 rounded-[2rem] border border-slate-800 shadow-xl">
                        <div class="bg-black/40 p-4 rounded-xl max-h-60 overflow-y-auto mb-6">${inscrisi.map(n => `<div class="flex justify-between items-center mb-2 text-[10px] font-bold"><span>${n}</span><select onchange="atribuiGrupaManual('${n}', this.value)" class="bg-slate-800 p-1 rounded text-white">${['','A','B','C','D','E','F','G','H'].map(g => `<option value="${g}">${g || 'Alege'}</option>`).join('')}</select></div>`).join('')}</div>
                        <button onclick="adminStartSezon()" class="w-full bg-blue-600 py-3 rounded-xl font-black uppercase text-[10px] text-white">Start Sezon</button></div>`;
                } else {
                    html += `<div class="text-center mb-6"><h2 class="text-4xl font-black italic uppercase text-white">Turneu Activ</h2></div>`;
                    const fazeMap = { f1: "Faza 1 (8 Grupe)", f2: "Faza 2 (4 Grupe)" };
                    ["f1", "f2"].forEach(f => {
                        if(!curSezon[f]) return;
                        html += `<div class="mb-10"><h3 class="text-slate-500 font-black uppercase text-[10px] text-center mb-4 tracking-widest">${fazeMap[f]}</h3><div class="grid grid-cols-2 gap-4">`;
                        Object.keys(curSezon[f]).sort().forEach(gk => {
                            html += `<div onclick="nav('grupa', '${gk}', '${f}')" class="bg-slate-900 p-6 rounded-2xl border border-slate-800 text-center cursor-pointer hover:border-blue-500 font-black text-white italic">Grupa ${gk}</div>`;
                        });
                        html += `</div></div>`;
                    });

                    if(isAdmin() && curSezon.f1 && !curSezon.f2) {
                        const gata = Object.values(curSezon.f1).every(g => g.meciuri.every(m => m.gata));
                        if(gata) html += `<button onclick="generaFazaUrmatoare()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black uppercase text-[10px] shadow-xl">Generează Faza 2 (Sistem X)</button>`;
                    }
                }
            } else if(state.pagina === "grupa") {
                html += `<button onclick="nav('home')" class="bg-slate-800 text-white px-6 py-3 rounded-xl font-black uppercase text-[10px] mb-8">← Înapoi</button>`;
                const g = curSezon[state.faza][state.idGrupa], c = calculeazaClasament(g);
                html += `<div class="text-center mb-6"><h3 class="text-2xl font-black italic uppercase text-white">Grupa ${state.idGrupa} (${state.faza.toUpperCase()})</h3></div>
                <div class="bg-slate-900 p-6 rounded-[2rem] mb-8 border border-slate-800"><table class="w-full text-[11px] font-bold">
                    <tr class="text-slate-500 uppercase"><th class="text-left">Jucător</th><th class="text-center">V</th><th class="text-center">C</th><th class="text-right">P</th></tr>
                    ${c.map(x => `<tr><td class="py-4 uppercase italic text-white">${x.nume}</td><td class="text-center text-blue-500">${x.victorii}</td><td class="text-center">${x.castigate}</td><td class="text-right text-slate-500">${x.pierdute}</td></tr>`).join('')}
                </table></div>`;
                g.meciuri.forEach(m => {
                    html += `<div class="bg-slate-900/50 p-4 rounded-2xl mb-3 flex justify-between items-center border border-white/5">
                        <div class="text-[10px] font-black uppercase italic text-white">${m.p1} vs ${m.p2}</div>
                        <div class="flex gap-2">
                            <button onclick="updateScorMeci('${state.faza}','${m.id}','t')" class="bg-black border border-slate-800 px-3 py-2 rounded-xl text-[10px] font-black text-white min-w-[55px]">${m.s1t}-${m.s2t}</button>
                            <button onclick="updateScorMeci('${state.faza}','${m.id}','r')" class="bg-black border border-slate-800 px-3 py-2 rounded-xl text-[10px] font-black text-white min-w-[55px]">${m.s1r}-${m.s2r}</button>
                        </div>
                    </div>`;
                });
            }
            root.innerHTML = html + `</div>`;
            document.getElementById('auth-ui').innerHTML = userLogat ? `<span>${userLogat.displayName}</span><button onclick="logout()" class="text-red-500 ml-2">Ieșire</button>` : '';
        }

        onAuthStateChanged(auth, u => { 
            userLogat = u; 
            onSnapshot(doc(db, "setari", "turnee"), s => { if(s.exists()) globalData = s.data(); render(); }); 
            onSnapshot(doc(db, "sezoane", `JOKER_1`), s => { if(s.exists()) currentSezonData = s.data(); render(); }); 
        });
    </script>
</head>
<body class="bg-black text-slate-300 font-sans tracking-tight mb-20"><div id="app"></div></body>
</html>
