<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turneu Joker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG5193qgq-dNX41yhCgXrl9WFNLhUiNnU",
            authDomain: "turneu-cruce.firebaseapp.com",
            projectId: "turneu-cruce",
            storageBucket: "turneu-cruce.firebasestorage.app",
            messagingSenderId: "169022341825",
            appId: "1:169022341825:web:53678e9ce275654bfe4a40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const ADMINS = ["isshmen@gmail.com", "admin@admin.ro"];
        let userLogat = null, currentSezonData = null, dateJucatori = {}, primaIncarcare = true;
        let state = { pagina: "home", idGrupa: null, search: "" };

        const isAdmin = () => userLogat && ADMINS.includes(userLogat.email);

        window.loginAdmin = async () => {
            const metoda = confirm("OK pentru Google / Cancel pentru Email");
            if (metoda) { signInWithPopup(auth, provider); } 
            else {
                const email = prompt("Email:", "admin@admin.ro"), pass = prompt("Parola:");
                if (email && pass) { try { await signInWithEmailAndPassword(auth, email, pass); } catch (e) { alert("Eroare!"); } }
            }
        };

        window.logout = () => signOut(auth);
        window.nav = (p, g=null) => { state = { ...state, pagina:p, idGrupa:g }; render(); };
        window.handleSearch = (val) => { state.search = val.toLowerCase(); render(); };

        // LOGICA NOTIFICARI (din codul de Chat)
        window.activeazaNotificari = () => {
            Notification.requestPermission().then(perm => { if (perm === "granted") alert("NotificƒÉri activate!"); });
        };

        const trimiteNotificareLocala = (titlu, msg) => {
            if (Notification.permission === "granted" && !primaIncarcare) {
                new Notification(titlu, { body: msg, icon: 'https://cdn-icons-png.flaticon.com/512/771/771239.png' });
            }
        };

        const drawUser = (nume, imgSize = "w-6 h-6", textSize = "text-[11px]") => {
            const userData = dateJucatori[nume], hasFoto = userData && userData.poza;
            return `<div class="flex items-center gap-2">
                ${hasFoto ? `<img src="${userData.poza}" class="${imgSize} rounded-full object-cover border border-white/10 shadow-sm">` : `<div class="${imgSize} rounded-full bg-slate-800 border border-white/5 flex items-center justify-center text-[8px] font-bold text-slate-500 uppercase">${nume.charAt(0)}</div>`}
                <span class="${textSize} uppercase italic font-medium truncate">${nume}</span>
            </div>`;
        };

        window.updateScorMeci = async (mId, set, p1, p2, tit) => {
            if(!isAdmin()) return;
            const val = prompt(`Scor (ex: 2-0):`);
            if(!val) return;
            let [v1, v2] = val.split("-").map(Number);
            let data = {...currentSezonData}, meci = data.f1[state.idGrupa].meciuri.find(m => m.id === mId);
            if (tit === p1) { meci[`s1${set}`] = v1; meci[`s2${set}`] = v2; }
            else { meci[`s1${set}`] = v2; meci[`s2${set}`] = v1; }
            meci.gata = true;
            await updateDoc(doc(db, "sezoane", "JOKER_2"), data);
        };

        const calculeazaClasament = (g) => {
            let st = {}; g.participanti.forEach(p => st[p] = { v: 0, c: 0, p: 0, nume: p });
            g.meciuri.forEach(m => {
                if(!m.gata) return;
                [{s1:m.s1t, s2:m.s2t}, {s1:m.s1r, s2:m.s2r}].forEach(s => {
                    if(s.s1 > s.s2) st[m.p1].v++; else if(s.s2 > s.s1) st[m.p2].v++;
                    st[m.p1].c += s.s1; st[m.p1].p += s.s2; st[m.p2].c += s.s2; st[m.p2].p += s.s1;
                });
            });
            return Object.values(st).sort((a,b) => b.v - a.v || b.c - a.c || a.p - b.p);
        };

        async function render() {
            const root = document.getElementById('app');
            let html = `<div class="max-w-2xl mx-auto p-4 text-white min-h-[85vh]">
                <nav class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
                    <h1 onclick="nav('home')" class="text-2xl font-black italic uppercase cursor-pointer">Joker <span class="text-blue-500">#2</span></h1>
                    <div>${userLogat ? `<button onclick="logout()" class="text-[10px] text-red-500 font-bold uppercase">Ie»ôire</button>` : `<button onclick="loginAdmin()" class="text-[10px] text-slate-500 font-bold uppercase">Admin</button>`}</div>
                </nav>`;

            if(state.pagina === "home") {
                html += `<div class="text-center mb-6"><h2 class="text-3xl font-black italic uppercase">Faza Grupelor</h2></div>
                         <div class="mb-6"><input type="text" placeholder="CautƒÉ jucƒÉtor..." value="${state.search}" oninput="handleSearch(this.value)" class="w-full bg-slate-900 border border-slate-800 p-4 rounded-2xl text-sm focus:border-blue-500 outline-none text-white font-bold"></div>
                         <div onclick="nav('podium')" class="bg-gradient-to-r from-blue-900/40 to-slate-900 border border-blue-500/30 p-6 rounded-3xl mb-10 cursor-pointer text-xs font-black uppercase tracking-widest text-blue-400 flex justify-between">
                            <span>C√¢»ôtigƒÉtor Edi»õia #1</span><span>üèÜ</span>
                         </div>
                         <div class="grid grid-cols-2 gap-4 mb-12">`;
                if(currentSezonData) {
                    Object.keys(currentSezonData.f1).sort().forEach(gk => {
                        if(!state.search || currentSezonData.f1[gk].participanti.some(p => p.toLowerCase().includes(state.search))) {
                            html += `<div onclick="nav('grupa', '${gk}')" class="bg-slate-900 p-10 rounded-3xl border border-slate-800 text-center cursor-pointer hover:border-blue-500 transition-all text-4xl font-black italic">${gk}</div>`;
                        }
                    });
                }
                html += `</div>`;

                if(currentSezonData) {
                    let toate = [];
                    Object.keys(currentSezonData.f1).forEach(gk => {
                        currentSezonData.f1[gk].meciuri.filter(m => m.gata).forEach(m => toate.push({...m, grupa: gk}));
                    });
                    const ultimele = toate.sort((a,b) => b.id.localeCompare(a.id)).slice(0, 8);
                    html += `<div class="mb-10"><h3 class="text-xs font-black uppercase text-slate-500 mb-4 ml-1 italic">Activitate</h3><div class="space-y-2">`;
                    ultimele.forEach(m => {
                        html += `<div class="bg-slate-900/40 border border-white/5 p-3 rounded-xl flex justify-between items-center text-[11px]">
                            <span class="text-blue-500 font-bold uppercase">Gr ${m.grupa}</span>
                            <span class="italic truncate px-2 font-medium">${m.p1} vs ${m.p2}</span>
                            <span class="font-black text-white bg-black px-2 py-1 rounded">(${m.s1t}-${m.s2t}) (${m.s1r}-${m.s2r})</span>
                        </div>`;
                    });
                    html += `</div></div>`;
                }

                html += `<div class="bg-blue-600/10 border border-blue-500/20 p-6 rounded-3xl text-center mb-10">
                    <button onclick="activeazaNotificari()" class="bg-blue-600 text-white text-[10px] font-black uppercase py-3 px-8 rounded-full shadow-lg">üîî Activare NotificƒÉri</button>
                </div>`;
            } else if(state.pagina === "podium") {
                const oviImg = dateJucatori["Ovidiu Miclaus"]?.poza || "";
                html += `<button onclick="nav('home')" class="mb-8 text-xs font-bold uppercase text-blue-500">‚Üê √énapoi</button>
                         <div class="space-y-4">
                            <div class="bg-gradient-to-r from-yellow-500/20 to-slate-900 border border-yellow-500/40 p-8 rounded-[2rem] flex justify-between items-center">
                                <div class="flex items-center gap-4">
                                    ${oviImg ? `<img src="${oviImg}" class="w-16 h-16 rounded-full border-2 border-yellow-500 object-cover">` : `<div class="w-16 h-16 rounded-full bg-slate-800 border-2 border-yellow-500"></div>`}
                                    <div><span class="block text-[10px] font-black uppercase text-yellow-500">Locul 1</span><span class="text-2xl font-black italic uppercase">Ovidiu Miclaus</span></div>
                                </div><div class="text-4xl">üèÜ</div>
                            </div>
                            <div class="bg-slate-900 p-6 rounded-[2rem] flex justify-between items-center">${drawUser("Gerard Miodrag", "w-12 h-12", "text-xl")}<div class="text-2xl opacity-50">ü•à</div></div>
                            <div class="bg-slate-900 p-6 rounded-[2rem] flex justify-between items-center">${drawUser("Dan Marius", "w-12 h-12", "text-xl")}<div class="text-2xl opacity-30">ü•â</div></div>
                         </div>`;
            } else if(state.pagina === "grupa") {
                const g = currentSezonData.f1[state.idGrupa], c = calculeazaClasament(g), top2 = c.slice(0, 2).map(x => x.nume);
                html += `<button onclick="nav('home')" class="mb-4 text-xs font-bold text-blue-500 uppercase">‚Üê √énapoi</button>
                         <div class="text-3xl font-black mb-8 uppercase italic text-center text-blue-500">Grupa ${state.idGrupa}</div>
                         <div class="bg-slate-900 p-4 rounded-3xl mb-10 border border-slate-800 overflow-hidden"><table class="w-full text-xs font-bold">
                            <tr class="text-slate-500 uppercase"><th class="text-left pb-2 pl-2">JucƒÉtor</th><th>V</th><th>C</th><th>P</th></tr>
                            ${c.map(x => `<tr class="border-t border-white/5 ${top2.includes(x.nume) ? 'text-green-500' : ''}">
                                <td class="py-3 pl-2">${drawUser(x.nume, "w-6 h-6")}</td><td class="text-center font-black">${x.v}</td><td class="text-center">${x.c}</td><td class="text-center">${x.p}</td>
                            </tr>`).join('')}</table></div>`;
                g.participanti.forEach(j => {
                    html += `<div class="mb-10"><div class="flex items-center gap-4 mb-5 ml-1 p-2 border-l-4 border-blue-500 bg-slate-900/30 rounded-r-xl">${drawUser(j, "w-14 h-14", "text-xl font-black")}</div>`;
                    g.meciuri.filter(m => m.p1 === j || m.p2 === j).forEach(m => {
                        const adv = m.p1 === j ? m.p2 : m.p1, sT = m.p1 === j ? `${m.s1t}-${m.s2t}` : `${m.s2t}-${m.s1t}`, sR = m.p1 === j ? `${m.s1r}-${m.s2r}` : `${m.s2r}-${m.s1r}`;
                        const pEu = dateJucatori[j]?.poza, pAd = dateJucatori[adv]?.poza;
                        html += `<div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5 mb-3 flex justify-between items-center shadow-sm">
                            <div class="flex items-center gap-3">
                                ${pEu ? `<img src="${pEu}" class="w-8 h-8 rounded-full object-cover">` : `<div class="w-8 h-8 rounded-full bg-slate-800"></div>`}
                                <span class="text-[10px] font-black text-slate-600 italic uppercase">vs</span>
                                <div class="flex items-center gap-2">
                                    ${pAd ? `<img src="${pAd}" class="w-8 h-8 rounded-full object-cover">` : `<div class="w-8 h-8 rounded-full bg-slate-800"></div>`}
                                    <span class="text-[11px] uppercase italic font-bold text-blue-400">${adv}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="updateScorMeci('${m.id}','t','${m.p1}','${m.p2}','${j}')" class="bg-black px-3 py-2 rounded-lg border border-slate-800 text-[10px] font-black uppercase">T: ${sT}</button>
                                <button onclick="updateScorMeci('${m.id}','r','${m.p1}','${m.p2}','${j}')" class="bg-black px-3 py-2 rounded-lg border border-slate-800 text-[10px] font-black uppercase">R: ${sR}</button>
                            </div></div>`;
                    });
                    html += `</div>`;
                });
            }
            root.innerHTML = html + `</div><footer class="mt-20 py-10 border-t border-slate-900 text-center"><p class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-600">&copy; 2026. Creat de <a href="https://www.facebook.com/isshmenn" target="_blank" class="text-blue-500">Vali Dragomir</a></p></footer>`;
        }

        onAuthStateChanged(auth, u => { userLogat = u; render(); });
        onSnapshot(doc(db, "sezoane", "JOKER_2"), s => { 
            if(s.exists()) { 
                const newData = s.data();
                if (!primaIncarcare) {
                    // VerificƒÉm dacƒÉ s-a schimbat vreun scor pentru notificare
                    trimiteNotificareLocala("Scor Nou!", "S-a actualizat un rezultat √Æn turneu.");
                }
                currentSezonData = newData; 
                primaIncarcare = false;
                render(); 
            } 
        });
        onSnapshot(collection(db, "jucatori"), s => { s.forEach(d => dateJucatori[d.id] = d.data()); render(); });
    </script>
</head>
<body class="bg-black font-sans tracking-tight"><div id="app"></div></body>
</html>
