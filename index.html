<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turneu Joker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG5193qgq-dNX41yhCgXrl9WFNLhUiNnU",
            authDomain: "turneu-cruce.firebaseapp.com",
            projectId: "turneu-cruce",
            storageBucket: "turneu-cruce.firebasestorage.app",
            messagingSenderId: "169022341825",
            appId: "1:169022341825:web:53678e9ce275654bfe4a40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const ADMINS = ["isshmen@gmail.com"];
        let userLogat = null;
        let globalData = { ed_JOKER: 2, inscrisi_JOKER: [] };
        let currentSezonData = null;
        let state = { pagina: "home", idGrupa: null, search: "" };

        const isAdmin = () => userLogat && ADMINS.includes(userLogat.email);

        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);
        window.nav = (p, g=null) => { state = { ...state, pagina:p, idGrupa:g }; render(); };
        window.handleSearch = (val) => { state.search = val.toLowerCase(); render(); };

        window.adminCorectieNume = async () => {
            if(!isAdmin() || !currentSezonData) return;
            let dataStr = JSON.stringify(currentSezonData);
            const schimbari = {
                "Andrei Mato": "Andrey Mato",
                "Botoș Flavius": "Botoș Marius",
                "Dan Flavius": "Dan Marius",
                "Jarsani Jawann": "Jacsonn Jacsonn",
                "Mariana Moiș": "Mariana Mois",
                "Roxana Valandman": "Roxana-Valentina Nani"
            };
            for (let [vechi, nou] of Object.entries(schimbari)) {
                dataStr = dataStr.split(vechi).join(nou);
            }
            try {
                await setDoc(doc(db, "sezoane", "JOKER_2"), JSON.parse(dataStr));
                alert("Nume corectate peste tot!");
            } catch (e) { alert(e.message); }
        };

        window.updateScorMeci = async (mId, set, p1, p2, titular) => {
            if(!isAdmin()) return alert("Doar adminul poate edita scorul!");
            const val = prompt(`Scor nou (ex: 2-0):`);
            if(!val) return;
            let [v1, v2] = val.split("-").map(Number);
            let data = {...currentSezonData};
            let meci = data.f1[state.idGrupa].meciuri.find(m => m.id === mId);
            if (titular === p1) { meci[`s1${set}`] = v1; meci[`s2${set}`] = v2; }
            else { meci[`s1${set}`] = v2; meci[`s2${set}`] = v1; }
            meci.gata = true;
            await updateDoc(doc(db, "sezoane", "JOKER_2"), data);
        };

        const calculeazaClasament = (g) => {
            let st = {};
            g.participanti.forEach(p => st[p] = { v: 0, c: 0, p: 0, nume: p });
            g.meciuri.forEach(m => {
                if(!m.gata) return;
                [{s1:m.s1t, s2:m.s2t}, {s1:m.s1r, s2:m.s2r}].forEach(s => {
                    if(s.s1 > s.s2) st[m.p1].v++; else if(s.s2 > s.s1) st[m.p2].v++;
                    st[m.p1].c += s.s1; st[m.p1].p += s.s2;
                    st[m.p2].c += s.s2; st[m.p2].p += s.s1;
                });
            });
            return Object.values(st).sort((a,b) => b.v - a.v || b.c - a.c || a.p - b.p);
        };

        async function render() {
            const root = document.getElementById('app');
            const turneuActiv = currentSezonData && currentSezonData.status === 'activ';
            let html = `<div class="max-w-2xl mx-auto p-4 text-white min-h-[85vh]">
                <nav class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
                    <h1 onclick="nav('home')" class="text-2xl font-black italic uppercase cursor-pointer">Joker <span class="text-blue-500">#2</span></h1>
                    <div>${userLogat ? `<button onclick="logout()" class="text-[10px] text-red-500 font-bold uppercase">Ieșire</button>` : ''}</div>
                </nav>`;

            if(!userLogat) {
                html += `<button onclick="loginGoogle()" class="w-full bg-white text-black py-4 rounded-xl font-bold uppercase shadow-lg text-xs">Login Admin</button>`;
            } else if(state.pagina === "home") {
                html += `<div class="text-center mb-6"><h2 class="text-3xl font-black italic uppercase">Faza Grupelor</h2></div>
                         <div class="mb-6"><input type="text" placeholder="Caută jucător..." value="${state.search}" oninput="handleSearch(this.value)" class="w-full bg-slate-900 border border-slate-800 p-4 rounded-2xl text-sm focus:border-blue-500 outline-none transition-all text-white"></div>`;
                
                html += `<div class="grid grid-cols-2 gap-4">`;
                if(turneuActiv) {
                    Object.keys(currentSezonData.f1).sort().forEach(gk => {
                        const participanti = currentSezonData.f1[gk].participanti;
                        if(!state.search || participanti.some(p => p.toLowerCase().includes(state.search))) {
                            html += `<div onclick="nav('grupa', '${gk}')" class="bg-slate-900 p-10 rounded-3xl border border-slate-800 text-center cursor-pointer hover:border-blue-500 transition-all text-4xl font-black italic">${gk}</div>`;
                        }
                    });
                }
                html += `</div>`;
            //  if(isAdmin()) html += `<button onclick="adminCorectieNume()" class="w-full mt-10 bg-orange-600/20 text-orange-500 border border-orange-600/30 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">Corectează Numele (O singură dată)</button>`;
            } else if(state.pagina === "grupa") {
                const g = currentSezonData.f1[state.idGrupa], c = calculeazaClasament(g), top2 = c.slice(0, 2).map(x => x.nume);
                html += `<button onclick="nav('home')" class="mb-4 text-xs font-bold uppercase text-blue-500 tracking-widest">← Înapoi</button>
                         <div class="text-3xl font-black mb-8 uppercase italic text-center text-blue-500">Grupa ${state.idGrupa}</div>
                         <div class="bg-slate-900 p-4 rounded-3xl mb-10 border border-slate-800 shadow-xl">
                            <table class="w-full text-xs font-bold"><tr class="text-slate-500 uppercase"><th class="text-left pb-2">Jucător</th><th>V</th><th>C</th><th>P</th></tr>
                            ${c.map(x => `<tr class="border-t border-white/5 ${top2.includes(x.nume) ? 'text-green-500' : ''}"><td class="py-3 uppercase italic">${x.nume}</td><td class="text-center font-black">${x.v}</td><td class="text-center">${x.c}</td><td class="text-center ${top2.includes(x.nume) ? 'text-green-900' : 'text-slate-500'}">${x.p}</td></tr>`).join('')}
                            </table></div>`;
                g.participanti.forEach(j => {
                    html += `<div class="mb-8"><h3 class="text-[10px] font-black uppercase text-slate-500 mb-3 ml-1 tracking-widest">${j}</h3>`;
                    g.meciuri.filter(m => m.p1 === j || m.p2 === j).forEach(m => {
                        const adv = m.p1 === j ? m.p2 : m.p1;
                        const sT = m.p1 === j ? `${m.s1t}-${m.s2t}` : `${m.s2t}-${m.s1t}`;
                        const sR = m.p1 === j ? `${m.s1r}-${m.s2r}` : `${m.s2r}-${m.s1r}`;
                        html += `<div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5 flex justify-between items-center mb-2 shadow-sm">
                            <span class="text-[11px] italic uppercase">${adv}</span>
                            <div class="flex gap-2">
                                <button onclick="updateScorMeci('${m.id}','t','${m.p1}','${m.p2}','${j}')" class="bg-black px-3 py-2 rounded-lg border border-slate-800 text-[10px] font-black uppercase">T: ${sT}</button>
                                <button onclick="updateScorMeci('${m.id}','r','${m.p1}','${m.p2}','${j}')" class="bg-black px-3 py-2 rounded-lg border border-slate-800 text-[10px] font-black uppercase">R: ${sR}</button>
                            </div></div>`;
                    });
                    html += `</div>`;
                });
            }
            root.innerHTML = html + `</div><footer class="mt-20 py-10 border-t border-slate-900 text-center"><p class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-600">&copy; 2026. Creat de <a href="https://www.facebook.com/isshmenn" target="_blank" class="text-blue-500">Vali Dragomir</a></p></footer>`;
        }

        onAuthStateChanged(auth, u => { 
            userLogat = u; 
            onSnapshot(doc(db, "setari", "turnee"), s => { if(s.exists()) globalData = s.data(); render(); }); 
            onSnapshot(doc(db, "sezoane", "JOKER_2"), s => { if(s.exists()) { currentSezonData = s.data(); render(); } }); 
        });
    </script>
</head>
<body class="bg-black font-sans tracking-tight"><div id="app"></div></body>
</html>

