<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campionat Cruce PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG5193qgq-dNX41yhCgXrl9WFNLhUiNnU",
            authDomain: "turneu-cruce.firebaseapp.com",
            projectId: "turneu-cruce",
            storageBucket: "turneu-cruce.firebasestorage.app",
            messagingSenderId: "169022341825",
            appId: "1:169022341825:web:53678e9ce275654bfe4a40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const ADMINS = ["isshmen@gmail.com"];
        let userLogat = null;
        let globalData = { ed_JOKER: 1, ed_JOLLY: 1, inscrisi_JOKER: [], inscrisi_JOLLY: [] };
        let state = { pagina: "home", tip: null, editie: null, idGrupa: null, faza: "f1", authTab: "login" };

        const curataNume = (n) => n ? n.replace(/\s*\(.*?\)\s*/g, "").trim() : "";
        const isAdmin = () => userLogat && ADMINS.includes(userLogat.email);

        window.nav = (p, t=null, e=null, g=null, f="f1") => { state = { ...state, pagina:p, tip:t, editie:e, idGrupa:g, faza:f }; render(); };
        window.setAuthTab = (tab) => { state.authTab = tab; render(); };

        window.handleEmailAuth = async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const pass = e.target.password.value;
            const nume = e.target.nume ? e.target.nume.value : null;
            try {
                if (state.authTab === 'register') {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(res.user, { displayName: nume });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
                nav('home');
            } catch (err) { alert(err.message); }
        };

        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        window.schimbaNume = async () => {
            const nou = prompt("Introdu numele tău real (ex: Nicolae Popa):", userLogat.displayName);
            if (nou) {
                await updateProfile(auth.currentUser, { displayName: nou });
                alert("Nume actualizat!");
                location.reload();
            }
        };

        window.gestiuneInscriere = async (tip, actiune, numeUser = null) => {
            const nume = numeUser || curataNume(userLogat?.displayName);
            if(!nume) return alert("Completează numele în profil!");
            const ref = doc(db, "setari", "turnee");
            await updateDoc(ref, { [`inscrisi_${tip}`]: actiune === 'add' ? arrayUnion(nume) : arrayRemove(nume) });
        };

        window.adminStartSezon = async (tip, ed) => {
            const inscrisi = globalData[`inscrisi_${tip}`] || [];
            if(inscrisi.length < 4) return alert("Minim 4!");
            const amestecati = [...inscrisi].sort(() => Math.random() - 0.5);
            let f1 = {};
            for(let i=0, gIdx=0; i < amestecati.length; gIdx++) {
                let dim = (amestecati.length - i === 5) ? 5 : 4;
                f1[String.fromCharCode(65 + gIdx)] = { participanti: amestecati.slice(i, i+dim), meciuri: creareMeciuri(amestecati.slice(i, i+dim)) };
                i += dim;
            }
            await setDoc(doc(db, "sezoane", `${tip}_${ed}`), { f1, f2: {}, f3: {}, f4: {}, finale: {} });
            await updateDoc(doc(db, "setari", "turnee"), { [`inscrisi_${tip}`]: [] });
        };

        const creareMeciuri = (lista, tipMeci = "standard") => {
            const m = [];
            if(tipMeci === "finale") {
                m.push({ id: "F-MICA", p1: lista[2], p2: lista[3], s1t: 0, s2t: 0, s1r: 0, s2r: 0, gata: false });
                m.push({ id: "F-MARE", p1: lista[0], p2: lista[1], s1t: 0, s2t: 0, s1r: 0, s2r: 0, gata: false });
            } else {
                for(let i=0; i<lista.length; i++) 
                    for(let j=i+1; j<lista.length; j++) 
                        m.push({ id: "M-"+Math.random().toString(36).substr(2,5), p1: lista[i], p2: lista[j], s1t: 0, s2t: 0, s1r: 0, s2r: 0, gata: false });
            }
            return m;
        };

        const calculeazaClasament = (g) => {
            if (!g) return [];
            let st = {};
            g.participanti.forEach(p => st[p] = { puncte: 0, castigate: 0, pierdute: 0, nume: p });
            g.meciuri.forEach(m => {
                if(!m.gata) return;
                [{s1: m.s1t, s2: m.s2t}, {s1: m.s1r, s2: m.s2r}].forEach(s => {
                    st[m.p1].castigate += s.s1; st[m.p1].pierdute += s.s2;
                    st[m.p2].castigate += s.s2; st[m.p2].pierdute += s.s1;
                    if(s.s1 > s.s2) st[m.p1].puncte += (s.s1 >= 2) ? 2 : 1;
                    else if(s.s2 > s.s1) st[m.p2].puncte += (s.s2 >= 2) ? 2 : 1;
                });
            });
            return Object.values(st).sort((a,b) => (b.puncte - a.puncte) || ((b.castigate-b.pierdute)-(a.castigate-a.pierdute)));
        };

        window.adminFazaUrmatoare = async (tip, ed) => {
            const docRef = doc(db, "sezoane", `${tip}_${ed}`);
            const snap = await getDoc(docRef);
            const data = snap.data();
            let curK = data.f4 && Object.keys(data.f4).length ? 'f4' : (data.f3 && Object.keys(data.f3).length ? 'f3' : (data.f2 && Object.keys(data.f2).length ? 'f2' : 'f1'));
            let nextK = curK === 'f1' ? 'f2' : (curK === 'f2' ? 'f3' : 'f4');
            const totalP = Object.values(data[curK]).reduce((a, b) => a + b.participanti.length, 0);
            if (Object.keys(data[curK]).length === 1 && totalP === 4) {
                const c = calculeazaClasament(data[curK]["A"]);
                await updateDoc(docRef, { finale: { participanti: c.map(x=>x.nume), meciuri: creareMeciuri(c.map(x=>x.nume), "finale") } });
                return;
            }
            let calif = [];
            Object.keys(data[curK]).sort().forEach(k => { const c = calculeazaClasament(data[curK][k]); calif.push(c[0].nume, c[1].nume); });
            let nf = {}; const amest = calif.sort(() => Math.random() - 0.5);
            for(let i=0, gIdx=0; i < amest.length; gIdx++) {
                let dim = (amest.length - i <= 5) ? amest.length - i : 4;
                nf[String.fromCharCode(65 + gIdx)] = { participanti: amest.slice(i, i+dim), meciuri: creareMeciuri(amest.slice(i, i+dim)) };
                i += dim;
            }
            await updateDoc(docRef, { [nextK]: nf });
        };

        window.adminInchideEd = async (tip) => {
            const ref = doc(db, "setari", "turnee");
            await updateDoc(ref, { [`ed_${tip}`]: (globalData[`ed_${tip}`] || 1) + 1 });
            nav('home');
        };

        window.updateScor = async (mId, tipScor) => {
            const docRef = doc(db, "sezoane", `${state.tip}_${state.editie}`);
            const snap = await getDoc(docRef);
            const data = snap.data();
            const faza = data[state.faza];
            const meci = state.faza === 'finale' ? faza.meciuri.find(m => m.id === mId) : faza[state.idGrupa].meciuri.find(m => m.id === mId);
            const numeCurat = curataNume(userLogat?.displayName);
            if(!isAdmin() && numeCurat !== meci.p1 && numeCurat !== meci.p2) return alert("Doar jucătorii din meci pot edita!");
            const val = prompt(`Scor ${meci.p1}-${meci.p2}:`); if(!val || !val.includes("-")) return;
            const [s1, s2] = val.split("-").map(Number);
            meci[tipScor === 't' ? 's1t' : 's1r'] = s1; meci[tipScor === 't' ? 's2t' : 's2r'] = s2;
            meci.gata = true;
            await updateDoc(docRef, { [state.faza]: faza });
        };

        async function render() {
            const root = document.getElementById('app');
            let html = `<div class="max-w-2xl mx-auto p-4">
                <nav class="flex justify-between items-center mb-10 border-b border-slate-800 pb-6">
                    <h1 onclick="nav('home')" class="font-black text-3xl cursor-pointer tracking-tighter text-white">CRUCE<span class="text-blue-500">PRO</span></h1>
                    <div id="auth-ui" class="text-xs font-bold uppercase tracking-widest"></div>
                </nav>`;

            if(!userLogat) {
                html += `<div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 max-w-sm mx-auto">
                    <div class="flex gap-4 mb-8">
                        <button onclick="setAuthTab('login')" class="flex-1 pb-2 border-b-2 ${state.authTab === 'login' ? 'border-blue-500 text-white' : 'border-transparent text-slate-500'} font-black uppercase text-xs">Login</button>
                        <button onclick="setAuthTab('register')" class="flex-1 pb-2 border-b-2 ${state.authTab === 'register' ? 'border-blue-500 text-white' : 'border-transparent text-slate-500'} font-black uppercase text-xs">Cont Nou</button>
                    </div>
                    <form onsubmit="handleEmailAuth(event)" class="space-y-4">
                        ${state.authTab === 'register' ? '<input type="text" name="nume" placeholder="Nume Complet (ex: Nicolae Popa)" class="w-full bg-black border border-slate-800 p-4 rounded-xl text-white text-sm" required>' : ''}
                        <input type="email" name="email" placeholder="Email" class="w-full bg-black border border-slate-800 p-4 rounded-xl text-white text-sm" required>
                        <input type="password" name="password" placeholder="Parola" class="w-full bg-black border border-slate-800 p-4 rounded-xl text-white text-sm" required>
                        <button class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-xs">${state.authTab === 'login' ? 'Intră în cont' : 'Creează Cont'}</button>
                    </form>
                    <div class="mt-6 pt-6 border-t border-slate-800">
                        <button onclick="loginGoogle()" class="w-full bg-white text-black py-4 rounded-xl font-black uppercase text-xs flex items-center justify-center gap-2">
                            <img src="https://www.google.com/favicon.ico" class="w-4 h-4"> Google Login
                        </button>
                    </div>
                </div>`;
            } else if(state.pagina === "home") {
                ["JOKER", "JOLLY"].forEach(tip => {
                    const ed = globalData[`ed_${tip}`] || 1;
                    const inscrisi = globalData[`inscrisi_${tip}`] || [];
                    html += `<div class="mb-12">
                        <h2 class="text-xs font-black text-slate-500 uppercase tracking-widest mb-4">Turneu ${tip}</h2>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="bg-slate-900 p-8 rounded-[2rem] border border-slate-800">
                                <div class="flex justify-between items-center mb-6">
                                    <div><div class="text-3xl font-black text-white italic">Ediția ${ed}</div><div class="text-[10px] text-slate-500 font-bold uppercase">În curs</div></div>
                                    <button onclick="nav('turneu', '${tip}', ${ed})" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black text-[10px] uppercase">Vezi Detalii</button>
                                </div>
                                <div class="bg-black/40 p-5 rounded-2xl border border-white/5">
                                    <div class="flex justify-between items-center mb-4"><span class="text-[10px] font-black uppercase text-slate-400">Înscrieri (${inscrisi.length})</span>
                                        <div class="flex gap-2">
                                            <button onclick="gestiuneInscriere('${tip}', 'rem')" class="bg-slate-800 text-white px-4 py-1 rounded-full text-[9px] font-black">Ies</button>
                                            <button onclick="gestiuneInscriere('${tip}', 'add')" class="bg-white text-black px-4 py-1 rounded-full text-[9px] font-black">Mă înscriu</button>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-2 text-[10px]">
                                        ${inscrisi.map(n => `<span class="bg-slate-800 px-3 py-1 rounded-lg text-slate-300 flex items-center gap-2">${n} ${isAdmin() ? `<b onclick="gestiuneInscriere('${tip}','rem','${n}')" class="text-red-500 cursor-pointer ml-1">X</b>` : ''}</span>`).join('') || "Niciun jucător înscris."}
                                    </div>
                                    ${isAdmin() ? `<button onclick="adminStartSezon('${tip}', ${ed})" class="w-full mt-6 bg-green-600 text-white py-3 rounded-xl text-[10px] font-black uppercase">Start Sezon ${ed}</button>` : ''}
                                </div>
                            </div>
                            <div onclick="nav('arhiva', '${tip}')" class="bg-slate-900/50 p-6 rounded-[1.5rem] border border-slate-800 text-center cursor-pointer hover:bg-slate-800 text-slate-500 font-black text-[10px] uppercase tracking-widest">Arhivă ${tip}</div>
                        </div>
                    </div>`;
                });
            } else if(state.pagina === "arhiva") {
                html += `<button onclick="nav('home')" class="mb-6 text-[10px] font-black text-slate-500 uppercase tracking-widest"> ← Acasă</button>
                <h2 class="text-4xl font-black text-white italic mb-8">Arhiva ${state.tip}</h2><div class="grid grid-cols-2 gap-4">`;
                for(let i=1; i < (globalData[`ed_${state.tip}`] || 1); i++) {
                    html += `<div onclick="nav('turneu', '${state.tip}', ${i})" class="bg-slate-900 p-8 rounded-[2rem] border border-slate-800 text-center cursor-pointer hover:border-white transition-all"><div class="text-2xl font-black text-white italic">Ediția ${i}</div></div>`;
                }
                html += `</div>`;
            } else if(state.pagina === "turneu") {
                const snap = await getDoc(doc(db, "sezoane", `${state.tip}_${state.editie}`));
                const data = snap.data();
                const esteGata = data?.finale?.meciuri?.find(m => m.id === "F-MARE")?.gata;
                html += `<button onclick="nav('home')" class="mb-6 text-[10px] font-black text-slate-500 uppercase tracking-widest"> ← Acasă</button>
                <div class="flex justify-between items-end mb-10"><h2 class="text-5xl font-black text-white italic tracking-tighter">${state.tip} <span class="text-blue-500">ed.${state.editie}</span></h2>
                ${(isAdmin() && esteGata) ? `<button onclick="adminInchideEd('${state.tip}')" class="bg-red-600 text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest">Închide Ediția</button>` : ''}</div>`;
                if(data) {
                    if(isAdmin() && !esteGata) html += `<button onclick="adminFazaUrmatoare('${state.tip}', ${state.editie})" class="w-full mb-8 bg-white text-black py-4 rounded-2xl font-black uppercase text-xs">Următoarea Fază</button>`;
                    ["f1", "f2", "f3", "f4", "finale"].forEach(f => {
                        if(!data[f] || (f !== 'finale' && Object.keys(data[f]).length === 0) || (f === 'finale' && !data[f].meciuri)) return;
                        const labelFaza = f === 'finale' ? 'FINALE' : 'FAZA ' + f.substring(1);
                        if(f === 'finale') {
                            const st = calculeazaClasament(data.finale);
                            html += `<div onclick="nav('grupa', '${state.tip}', ${state.editie}, 'FINALE', 'finale')" class="bg-slate-900 p-10 rounded-[2.5rem] border border-slate-800 text-center cursor-pointer mb-6 shadow-2xl"><div class="text-4xl font-black text-white italic tracking-widest mb-4">FINALELE</div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div class="bg-black/40 p-3 rounded-xl border border-yellow-500/20"><div class="text-[7px] font-black text-yellow-500 uppercase">Loc 1</div><div class="text-[10px] font-bold text-white truncate">${st[0]?.nume || '-'}</div></div>
                                    <div class="bg-black/40 p-3 rounded-xl border border-slate-400/20"><div class="text-[7px] font-black text-slate-400 uppercase">Loc 2</div><div class="text-[10px] font-bold text-white truncate">${st[1]?.nume || '-'}</div></div>
                                    <div class="bg-black/40 p-3 rounded-xl border border-orange-800/20"><div class="text-[7px] font-black text-orange-800 uppercase">Loc 3</div><div class="text-[10px] font-bold text-white truncate">${st[2]?.nume || '-'}</div></div>
                                </div></div>`;
                        } else {
                            html += `<div class="grid grid-cols-2 gap-4 mb-8">`;
                            Object.keys(data[f]).sort().forEach(gk => {
                                html += `<div onclick="nav('grupa', '${state.tip}', ${state.editie}, '${gk}', '${f}')" class="bg-slate-900 p-10 rounded-[2rem] border border-slate-800 text-center cursor-pointer hover:border-white transition-all shadow-lg">
                                    <div class="text-[10px] font-black text-slate-500 uppercase mb-1">${labelFaza}</div><div class="text-3xl font-black text-white italic">Grupa ${gk}</div>
                                </div>`;
                            });
                            html += `</div>`;
                        }
                    });
                } else { html += `<div class="text-center py-20 text-slate-700 font-black uppercase text-[10px]">Ediția nu a început încă.</div>`; }
            } else if(state.pagina === "grupa") {
                const snap = await getDoc(doc(db, "sezoane", `${state.tip}_${state.editie}`));
                const d = snap.data();
                const g = state.faza === 'finale' ? d.finale : d[state.faza][state.idGrupa];
                html += `<button onclick="nav('turneu', '${state.tip}', ${state.editie})" class="mb-6 text-[10px] font-black text-slate-500 uppercase tracking-widest"> ← Înapoi</button>
                <h2 class="text-6xl font-black text-white italic mb-10 tracking-tighter">${state.faza === 'finale' ? 'FINALE' : 'Grupa ' + state.idGrupa}</h2>`;
                if(state.faza !== 'finale') {
                    const c = calculeazaClasament(g);
                    html += `<div class="bg-slate-900 rounded-[2rem] p-8 mb-12 border border-slate-800"><table class="w-full text-left"><tr class="text-[9px] font-black uppercase text-slate-600 border-b border-slate-800"><th class="pb-4">Jucător</th><th class="pb-4 text-center">Pct</th><th class="pb-4 text-right">Set</th></tr>
                        ${c.map((x,i) => `<tr class="border-b border-slate-800/50"><td class="py-4 font-black ${i<2?'text-green-500':'text-white'}">${i+1}. ${x.nume}</td><td class="text-center font-black">${x.puncte}</td><td class="text-right text-slate-500 font-mono text-xs">${x.castigate}-${x.pierdute}</td></tr>`).join('')}
                    </table></div>`;
                }
                g.participanti.forEach(juc => {
                    html += `<div class="bg-slate-900 p-8 rounded-[2rem] mb-8 border border-slate-800"><div class="text-2xl font-black mb-6 text-white border-b border-slate-800 pb-4">${juc}</div>`;
                    g.meciuri.filter(m => m.p1 === juc || m.p2 === juc).forEach(m => {
                        const sL = state.faza === 'finale' ? '3/5' : 'Scor';
                        html += `<div class="bg-black/40 p-5 rounded-2xl mb-4 border border-white/5 flex justify-between items-center"><div class="text-[10px] font-black text-slate-500 uppercase">${m.p1} vs ${m.p2}</div><div class="flex gap-4">
                                <div onclick="updateScor('${m.id}','t')" class="bg-slate-800 hover:bg-blue-600 px-4 py-2 rounded-xl cursor-pointer min-w-[70px] text-center"><span class="block text-[7px] opacity-40 uppercase">T</span><span class="text-lg font-black text-white">${m.s1t}:${m.s2t}</span></div>
                                <div onclick="updateScor('${m.id}','r')" class="bg-slate-800 hover:bg-blue-600 px-4 py-2 rounded-xl cursor-pointer min-w-[70px] text-center"><span class="block text-[7px] opacity-40 uppercase">R</span><span class="text-lg font-black text-white">${m.s1r}:${m.s2r}</span></div>
                            </div></div>`;
                    });
                    html += `</div>`;
                });
            }
            root.innerHTML = html + `</div>`;
            document.getElementById('auth-ui').innerHTML = userLogat ? `<span onclick="schimbaNume()" class="opacity-50 mr-2 text-[10px] font-black cursor-pointer hover:text-white">${curataNume(userLogat.displayName)}</span><button onclick="logout()" class="text-red-500 font-black">Ieșire</button>` : '';
        }
        
        onAuthStateChanged(auth, u => { 
            userLogat = u; 
            onSnapshot(doc(db, "setari", "turnee"), s => { if(s.exists()) globalData = s.data(); render(); });
        });
    </script>
</head>
<body class="bg-black text-slate-300 font-sans pb-24"><div id="app"></div></body>
</html>
