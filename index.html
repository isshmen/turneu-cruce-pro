<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joker Championship</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG5193qgq-dNX41yhCgXrl9WFNLhUiNnU",
            authDomain: "turneu-cruce.firebaseapp.com",
            projectId: "turneu-cruce",
            storageBucket: "turneu-cruce.firebasestorage.app",
            messagingSenderId: "169022341825",
            appId: "1:169022341825:web:53678e9ce275654bfe4a40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const ADMINS = ["isshmen@gmail.com"];
        let userLogat = null;
        let globalData = { ed_JOKER: 1, inscrisi_JOKER: [] };
        let state = { pagina: "home", idGrupa: null, faza: "f1", manualGrupe: {} };

        const curataNume = (n) => n ? n.replace(/\s*\(.*?\)\s*/g, "").trim() : "";
        const isAdmin = () => userLogat && ADMINS.includes(userLogat.email);

        window.nav = (p, g=null, f="f1") => { state = { ...state, pagina:p, idGrupa:g, faza:f }; render(); };

        const calculeazaClasament = (g) => {
            if (!g) return [];
            let st = {};
            g.participanti.forEach(p => st[p] = { puncte: 0, realizate: 0, pierdute: 0, nume: p });
            g.meciuri.forEach(m => {
                if(!m.gata) return;
                [{s1: m.s1t, s2: m.s2t}, {s1: m.s1r, s2: m.s2r}].forEach(s => {
                    if(s.s1 > s.s2) st[m.p1].puncte += 2; else if(s.s2 > s.s1) st[m.p2].puncte += 2;
                    st[m.p1].realizate += s.s1; st[m.p1].pierdute += s.s2;
                    st[m.p2].realizate += s.s2; st[m.p2].pierdute += s.s1;
                });
            });
            return Object.values(st).sort((a,b) => (b.puncte - a.puncte) || (b.realizate - a.realizate) || (a.pierdute - b.pierdute));
        };

        const generareCardMeci = (p1, p2, tip="standard") => ({
            id: "M-" + Math.random().toString(36).substr(2, 9),
            p1, p2, s1t: 0, s2t: 0, s1r: 0, s2r: 0, s1_3: 0, s2_3: 0, s1_4: 0, s2_4: 0, s1_5: 0, s2_5: 0, gata: false, tip
        });

        window.adminHardReset = async () => {
            if(!confirm("ȘTERGI TOT SEZONUL CURENT?")) return;
            await deleteDoc(doc(db, "sezoane", `JOKER_${globalData.ed_JOKER}`));
            await updateDoc(doc(db, "setari", "turnee"), { inscrisi_JOKER: [] });
            location.reload();
        };

        window.adminImportJucatori = async () => {
            const lista = prompt("Introdu lista de nume separate prin virgula:");
            if(!lista) return;
            const numeArray = lista.split(",").map(n => n.trim()).filter(n => n.length > 0);
            await updateDoc(doc(db, "setari", "turnee"), { "inscrisi_JOKER": arrayUnion(...numeArray) });
        };

        window.adminStartSezon = async () => {
            const ed = globalData.ed_JOKER || 1;
            const inscrisi = globalData.inscrisi_JOKER || [];
            let f1 = {};
            const grupeUnice = [...new Set(Object.values(state.manualGrupe))].sort();
            
            grupeUnice.forEach(gk => {
                const p = inscrisi.filter(n => state.manualGrupe[n] === gk);
                if(p.length > 0) {
                    f1[gk] = { participanti: p, meciuri: [] };
                    for(let i=0; i<p.length; i++) for(let j=i+1; j<p.length; j++) f1[gk].meciuri.push(generareCardMeci(p[i], p[j]));
                }
            });

            if(Object.keys(f1).length === 0) return alert("Atribuie măcar un jucător unei grupe!");
            await setDoc(doc(db, "sezoane", `JOKER_${ed}`), { f1, f2: null, status: 'activ' });
            await updateDoc(doc(db, "setari", "turnee"), { "inscrisi_JOKER": [] });
        };

        window.adminFazaUrmatoare = async () => {
            const ed = globalData.ed_JOKER;
            const docRef = doc(db, "sezoane", `JOKER_${ed}`);
            const snap = await getDoc(docRef);
            const data = snap.data();
            const getWin = (m) => (m.s1t+m.s1r > m.s2t+m.s2r) ? m.p1 : m.p2;

            if (!data.f2) {
                let calif = {}; 
                Object.keys(data.f1).sort().forEach(gk => { calif[gk] = calculeazaClasament(data.f1[gk]).slice(0, 2); });
                let meciuri = [];
                const keys = Object.keys(calif).sort();
                for(let i=0; i<keys.length; i+=2) {
                    if(keys[i+1]) {
                        meciuri.push(generareCardMeci(calif[keys[i]][0].nume, calif[keys[i+1]][1].nume));
                        meciuri.push(generareCardMeci(calif[keys[i]][1].nume, calif[keys[i+1]][0].nume));
                    }
                }
                await updateDoc(docRef, { f2: { meciuri } });
            } else if (!data.optimi) {
                const castig = data.f2.meciuri.map(getWin).sort(() => Math.random() - 0.5);
                let meciuri = [];
                for(let i=0; i<castig.length; i+=2) if(castig[i+1]) meciuri.push(generareCardMeci(castig[i], castig[i+1]));
                await updateDoc(docRef, { optimi: { meciuri } });
            } else if (!data.semi) {
                const castig = data.optimi.meciuri.map(getWin).sort(() => Math.random() - 0.5);
                let meciuri = [];
                for(let i=0; i<castig.length; i+=2) if(castig[i+1]) meciuri.push(generareCardMeci(castig[i], castig[i+1]));
                await updateDoc(docRef, { semi: { meciuri } });
            } else if (!data.finale) {
                const castig = data.semi.meciuri.map(getWin);
                const pierz = data.semi.meciuri.map(m => getWin(m) === m.p1 ? m.p2 : m.p1);
                await updateDoc(docRef, { finale: { mare: generareCardMeci(castig[0], castig[1], "3/5"), mica: generareCardMeci(pierz[0], pierz[1], "3/5") }});
            }
        };

        window.updateScorMeci = async (faza, mId, set, isMare = false) => {
            const ed = globalData.ed_JOKER;
            const snap = await getDoc(doc(db, "sezoane", `JOKER_${ed}`));
            let data = snap.data();
            let meci;
            if(faza === 'f1') meci = data.f1[state.idGrupa].meciuri.find(m => m.id === mId);
            else if(faza === 'finale') meci = isMare ? data.finale.mare : data.finale.mica;
            else meci = data[faza].meciuri.find(m => m.id === mId);

            const val = prompt(`Scor (ex: 2-1):`); if(!val) return;
            const [s1, s2] = val.split("-").map(Number);
            meci[`s1${set}`] = s1; meci[`s2${set}`] = s2; meci.gata = true;
            await updateDoc(doc(db, "sezoane", `JOKER_${ed}`), data);
        };

        window.atribuiGrupaManual = (n, v) => { state.manualGrupe[n] = v; render(); };
        window.gestiuneInscriere = async (a) => { await updateDoc(doc(db, "setari", "turnee"), { "inscrisi_JOKER": a === 'add' ? arrayUnion(curataNume(userLogat.displayName)) : arrayRemove(curataNume(userLogat.displayName)) }); };
        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        async function render() {
            const root = document.getElementById('app');
            const ed = globalData.ed_JOKER || 1;
            const snap = await getDoc(doc(db, "sezoane", `JOKER_${ed}`));
            const curSezon = snap.exists() ? snap.data() : null;

            let html = `<div class="max-w-2xl mx-auto p-4"><nav class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4"><h1 onclick="nav('home')" class="font-black text-2xl text-white italic uppercase tracking-tighter">Joker <span class="text-blue-500">#${ed}</span></h1><div id="auth-ui"></div></nav>`;

            if(!userLogat) {
                html += `<button onclick="loginGoogle()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-sm">Autentificare Google</button>`;
            } else if(state.pagina === "home") {
                if(!curSezon || curSezon.status !== 'activ') {
                    const inscrisi = globalData.inscrisi_JOKER || [];
                    html += `<div class="bg-slate-900 p-6 rounded-3xl border border-slate-800"><div class="flex justify-between mb-6 items-center"><span class="font-black uppercase text-[10px] text-slate-500">Inscrieri (${inscrisi.length})</span>
                        <div class="flex gap-2">
                            <button onclick="gestiuneInscriere('rem')" class="bg-slate-800 px-3 py-1 rounded-lg text-[10px] font-black uppercase">Ies</button>
                            <button onclick="gestiuneInscriere('add')" class="bg-white text-black px-3 py-1 rounded-lg text-[10px] font-black uppercase">Inscriere</button>
                        </div></div>
                        <div class="flex flex-wrap gap-2 mb-8">${inscrisi.map(n => `<span class="bg-black/50 border border-white/5 p-2 rounded-lg text-[10px] font-bold">${n}</span>`).join('')}</div>
                        ${isAdmin() ? `<div class="space-y-3 pt-4 border-t border-slate-800">
                        <button onclick="adminImportJucatori()" class="w-full bg-slate-800 py-3 rounded-xl font-black uppercase text-[10px]">Importa Lista Nume</button>
                        <div class="bg-black/20 p-4 rounded-xl space-y-2 max-h-60 overflow-y-auto">${inscrisi.map(n => `<div class="flex justify-between text-xs"><span>${n}</span><select onchange="atribuiGrupaManual('${n}', this.value)" class="bg-slate-800 rounded px-1"><option value="">-</option>${['A','B','C','D','E','F','G','H'].map(l => `<option value="${l}" ${state.manualGrupe[n]===l?'selected':''}>${l}</option>`).join('')}</select></div>`).join('')}</div>
                        <button onclick="adminStartSezon()" class="w-full bg-green-600 py-4 rounded-2xl font-black uppercase text-xs">Porneste Grupele</button></div>` : ''}</div>`;
                } else {
                    const fazeInfo = { f1: "Faza Grupelor", f2: "16-imi (Tur-Retur)", optimi: "Optimi", semi: "Semifinale", finale: "Marea Finala" };
                    ["f1", "f2", "optimi", "semi", "finale"].forEach(f => {
                        if(!curSezon[f]) return;
                        html += `<div class="mb-10"><h3 class="text-blue-500 font-black uppercase text-[10px] mb-4 text-center tracking-widest">${fazeInfo[f]}</h3><div class="grid grid-cols-2 gap-3">`;
                        if(f === 'f1') {
                            Object.keys(curSezon.f1).sort().forEach(gk => { html += `<div onclick="nav('grupa', '${gk}', 'f1')" class="bg-slate-900 p-6 rounded-2xl border border-slate-800 text-center cursor-pointer font-black italic uppercase">Grupa ${gk}</div>`; });
                        } else if(f === 'finale') {
                            html += `<div onclick="nav('grupa', 'FINALE', 'finale')" class="col-span-2 bg-gradient-to-r from-blue-700 to-indigo-900 p-6 rounded-2xl text-center font-black uppercase italic">Vezi Finalele</div>`;
                        } else {
                            html += `<div onclick="nav('grupa', '${f}', '${f}')" class="col-span-2 bg-slate-900 p-4 rounded-2xl text-center font-black uppercase text-[10px] border border-slate-800 tracking-widest">Meciuri Eliminatorii</div>`;
                        }
                        html += `</div></div>`;
                    });
                    if(isAdmin()) html += `<div class="flex gap-2"><button onclick="adminFazaUrmatoare()" class="flex-1 bg-white text-black py-4 rounded-2xl font-black uppercase text-xs">Urmatoarea Faza</button><button onclick="adminHardReset()" class="bg-red-900 text-white px-4 rounded-2xl text-[10px] font-black uppercase">Reset</button></div>`;
                }
            } else if(state.pagina === "grupa") {
                html += `<button onclick="nav('home')" class="text-[10px] font-black text-slate-500 mb-6 uppercase tracking-widest">← Inapoi</button>`;
                if(state.faza === 'f1') {
                    const g = curSezon.f1[state.idGrupa];
                    const c = calculeazaClasament(g);
                    html += `<div class="bg-slate-900 p-4 rounded-2xl mb-6 border border-slate-800"><table class="w-full text-xs font-bold"><tr class="text-slate-500 text-[9px] uppercase"><th class="text-left pb-4">Nume</th><th class="text-center pb-4">Pct</th><th class="text-center pb-4">R</th><th class="text-right pb-4">P</th></tr>
                        ${c.map(x => `<tr class="border-t border-slate-800/50"><td class="py-3 uppercase italic">${x.nume}</td><td class="text-center text-blue-500">${x.puncte}</td><td class="text-center">${x.realizate}</td><td class="text-right text-slate-500">${x.pierdute}</td></tr>`).join('')}</table></div>`;
                    g.meciuri.forEach(m => {
                        html += `<div class="bg-slate-900/40 p-4 rounded-xl mb-2 flex justify-between items-center border border-white/5"><span class="text-[10px] font-black uppercase italic">${m.p1} vs ${m.p2}</span>
                            <div class="flex gap-2"><button onclick="updateScorMeci('f1','${m.id}','t')" class="bg-black border border-slate-800 px-3 py-1 rounded-lg text-xs font-black min-w-[50px]">${m.s1t}-${m.s2t}</button>
                            <button onclick="updateScorMeci('f1','${m.id}','r')" class="bg-black border border-slate-800 px-3 py-1 rounded-lg text-xs font-black min-w-[50px]">${m.s1r}-${m.s2r}</button></div></div>`;
                    });
                } else {
                    const meciuri = state.faza === 'finale' ? [curSezon.finale.mare, curSezon.finale.mica] : curSezon[state.faza].meciuri;
                    meciuri.forEach((m, idx) => {
                        const is35 = m.tip === "3/5";
                        html += `<div class="bg-slate-900 p-6 rounded-3xl mb-4 border border-slate-800"><div class="text-center font-black text-[11px] mb-4 uppercase tracking-tighter text-blue-400">${m.p1} vs ${m.p2}</div>
                            <div class="flex flex-wrap justify-center gap-2">${['t','r','_3','_4','_5'].slice(0, is35 ? 5 : 2).map(s => `
                                <button onclick="updateScorMeci('${state.faza}','${m.id}','${s}', ${idx===0 && state.faza==='finale'})" class="bg-black border border-slate-800 p-3 rounded-xl text-xs font-black min-w-[55px]">${m['s1'+s]}-${m['s2'+s]}</button>
                            `).join('')}</div></div>`;
                    });
                }
            }
            root.innerHTML = html + `</div>`;
            document.getElementById('auth-ui').innerHTML = userLogat ? `<button onclick="logout()" class="text-slate-500 font-black text-[10px] uppercase">Logout</button>` : '';
        }

        onAuthStateChanged(auth, u => { userLogat = u; onSnapshot(doc(db, "setari", "turnee"), s => { if(s.exists()) { globalData = s.data(); render(); }}); });
    </script>
</head>
<body class="bg-black text-slate-300 font-sans tracking-tight"><div id="app"></div></body>
</html>
