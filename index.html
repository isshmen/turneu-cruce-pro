<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turneu Joker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, arrayUnion, arrayRemove, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG5193qgq-dNX41yhCgXrl9WFNLhUiNnU",
            authDomain: "turneu-cruce.firebaseapp.com",
            projectId: "turneu-cruce",
            storageBucket: "turneu-cruce.firebasestorage.app",
            messagingSenderId: "169022341825",
            appId: "1:169022341825:web:53678e9ce275654bfe4a40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const ADMINS = ["isshmen@gmail.com", "admin@admin.ro"];
        let userLogat = null;
        let globalData = { ed_JOKER: 2, inscrisi_JOKER: [] };
        let currentSezonData = null;
        let state = { pagina: "home", idGrupa: null, faza: "f1", manualGrupe: {}, authTab: 'login', search: "" };

        const isAdmin = () => userLogat && ADMINS.includes(userLogat.email);
        const curataNume = (n) => n ? n.replace(/\s*\(.*?\)\s*/g, "").trim() : "";

        window.nav = (p, g=null, f="f1") => { state = { ...state, pagina:p, idGrupa:g, faza:f }; render(); };
        window.setAuthTab = (t) => { state.authTab = t; render(); };
        window.handleSearch = (val) => { state.search = val.toLowerCase(); render(); };

        window.handleEmailAuth = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const email = fd.get('email'), pass = fd.get('password'), nume = fd.get('nume');
            try {
                if(state.authTab === 'register') {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(res.user, { displayName: nume });
                    await setDoc(doc(db, "users", res.user.uid), { nume: nume });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (err) { alert(err.message); }
        };

        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        window.gestiuneInscriere = async (tip) => {
            if(!userLogat) return alert("Trebuie să fii logat!");
            const nume = curataNume(userLogat.displayName);
            const ref = doc(db, "setari", "turnee");
            if(tip === 'add') await updateDoc(ref, { inscrisi_JOKER: arrayUnion(nume) });
            else await updateDoc(ref, { inscrisi_JOKER: arrayRemove(nume) });
        };

        window.adminImportJucatori = async () => {
            const lista = ["Jucator 1", "Jucator 2", "Jucator 3", "Jucator 4", "Jucator 5", "Jucator 6", "Jucator 7", "Jucator 8", "Jucator 9", "Jucator 10", "Jucator 11", "Jucator 12", "Jucator 13", "Jucator 14", "Jucator 15", "Jucator 16", "Jucator 17", "Jucator 18", "Jucator 19", "Jucator 20", "Jucator 21", "Jucator 22", "Jucator 23", "Jucator 24", "Jucator 25", "Jucator 26", "Jucator 27", "Jucator 28", "Jucator 29", "Jucator 30", "Jucator 31", "Jucator 32", "Jucator 33", "Jucator 34", "Jucator 35"]; 
            if(confirm(`Importi ${lista.length} jucatori individuali?`)) {
                await updateDoc(doc(db, "setari", "turnee"), { inscrisi_JOKER: lista });
                alert("Lista a fost importată!");
            }
        };

        window.adminStartSezon = async () => {
            let inscrisi = [...globalData.inscrisi_JOKER];
            if(inscrisi.length === 0) return alert("Lista de înscriși este goală!");
            
            let f1 = {};
            const gList = ['A','B','C','D','E','F','G','H'];
            inscrisi.sort(() => Math.random() - 0.5);
            
            let pointer = 0;
            gList.forEach((gk, idx) => {
                let nr = idx < 3 ? 5 : 4;
                let p = inscrisi.slice(pointer, pointer + nr);
                pointer += nr;
                if(p.length > 0) {
                    f1[gk] = { participanti: p, meciuri: [] };
                    for(let i=0; i<p.length; i++) {
                        for(let j=i+1; j<p.length; j++) {
                            f1[gk].meciuri.push({ id: "M-"+Math.random().toString(36).substr(2,9), p1: p[i], p2: p[j], s1t:0, s2t:0, s1r:0, s2r:0, gata: false });
                        }
                    }
                }
            });
            await setDoc(doc(db, "sezoane", `JOKER_2`), { f1, status: 'activ' });
        };

        const calculeazaClasament = (g) => {
            if (!g) return [];
            let st = {};
            g.participanti.forEach(p => st[p] = { victorii: 0, castigate: 0, pierdute: 0, nume: p });
            g.meciuri.forEach(m => {
                if(!m.gata) return;
                [{s1: m.s1t, s2: m.s2t}, {s1: m.s1r, s2: m.s2r}].forEach(s => {
                    if(s.s1 > s.s2) st[m.p1].victorii += 1; 
                    else if(s.s2 > s.s1) st[m.p2].victorii += 1;
                    st[m.p1].castigate += s.s1; st[m.p1].pierdute += s.s2;
                    st[m.p2].castigate += s.s2; st[m.p2].pierdute += s.s1;
                });
            });
            return Object.values(st).sort((a,b) => (b.victorii - a.victorii) || (b.castigate - a.castigate) || (a.pierdute - b.pierdute));
        };

        window.updateScorMeci = async (faza, mId, set, p1, p2, titularCurent) => {
            if(!isAdmin()) return alert("Doar administratorii pot modifica scorul!");
            const val = prompt(`Scor (ex: 2-0):`);
            if(!val) return;
            let [v1, v2] = val.split("-").map(Number);
            let data = {...currentSezonData};
            let meci = data[faza][state.idGrupa].meciuri.find(m => m.id === mId);
            if (titularCurent === p1) { meci[`s1${set}`] = v1; meci[`s2${set}`] = v2; }
            else { meci[`s1${set}`] = v2; meci[`s2${set}`] = v1; }
            meci.gata = true;
            await updateDoc(doc(db, "sezoane", `JOKER_2`), data);
        };

        async function render() {
            const root = document.getElementById('app');
            const ed = globalData.ed_JOKER || 2;
            const turneuActiv = currentSezonData && currentSezonData.status === 'activ';

            let html = `<div class="max-w-2xl mx-auto p-4"><nav class="flex justify-between items-center mb-10 border-b border-slate-800 pb-6">
                <h1 onclick="nav('home')" class="font-black text-3xl cursor-pointer text-white uppercase italic">Joker<span class="text-blue-500 ml-1">#${ed}</span></h1>
                <div id="auth-ui" class="text-[10px] font-black uppercase text-slate-500"></div></nav>`;

            if(!userLogat) {
                html += `<div class="bg-slate-900 p-8 rounded-[2rem] border border-slate-800 max-w-sm mx-auto shadow-2xl">
                    <div class="flex gap-4 mb-8"><button onclick="setAuthTab('login')" class="flex-1 pb-2 border-b-2 ${state.authTab === 'login' ? 'border-blue-500 text-white' : 'border-transparent text-slate-500'} font-black uppercase text-[10px]">Login</button><button onclick="setAuthTab('register')" class="flex-1 pb-2 border-b-2 ${state.authTab === 'register' ? 'border-blue-500 text-white' : 'border-transparent text-slate-500'} font-black uppercase text-[10px]">Cont Nou</button></div>
                    <form onsubmit="handleEmailAuth(event)" class="space-y-4">${state.authTab === 'register' ? '<input type="text" name="nume" placeholder="Nume Complet" class="w-full bg-black border border-slate-800 p-4 rounded-xl text-white text-sm" required>' : ''}<input type="email" name="email" placeholder="Email" class="w-full bg-black border border-slate-800 p-4 rounded-xl text-white text-sm" required><input type="password" name="password" placeholder="Parola" class="w-full bg-black border border-slate-800 p-4 rounded-xl text-white text-sm" required><button class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-xs">OK</button></form>
                    <div class="text-center my-4 text-[10px] font-black text-slate-600">SAU</div><button onclick="loginGoogle()" class="w-full bg-white text-black py-4 rounded-xl font-black uppercase text-xs">Google Login</button></div>`;
            } else if(state.pagina === "home") {
                if(!turneuActiv) {
                    const inscrisi = globalData.inscrisi_JOKER || [];
                    html += `<div class="bg-slate-900 p-8 rounded-[2rem] border border-slate-800 shadow-xl"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-black text-white italic uppercase">Înscrieri Ediția ${ed}</h2><div class="flex gap-2"><button onclick="gestiuneInscriere('rem')" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">Ies</button><button onclick="gestiuneInscriere('add')" class="bg-white text-black px-4 py-2 rounded-xl text-[10px] font-black uppercase">Înscriere</button></div></div>
                        <div class="flex flex-wrap gap-2 mb-8">${inscrisi.map(n => `<span class="bg-black/50 px-3 py-2 rounded-xl text-[10px] font-bold border border-white/5 uppercase">${n}</span>`).join('')}</div>
                        ${isAdmin() ? `<div class="space-y-4 pt-6 border-t border-slate-800"><button onclick="window.adminImportJucatori()" class="w-full bg-slate-800 text-white py-3 rounded-xl text-[10px] font-black uppercase">Importă Listă 35</button><button onclick="window.adminStartSezon()" class="w-full bg-green-600 py-3 rounded-xl font-black uppercase text-[10px]">Start Sezon (1 vs 1)</button></div>` : ''}</div>`;
                } else {
                    html += `<div class="text-center mb-6"><h2 class="text-4xl font-black italic uppercase text-white">Faza Grupelor</h2></div>
                        <div class="mb-10 px-2"><input type="text" placeholder="Caută jucător..." value="${state.search}" oninput="handleSearch(this.value)" class="w-full bg-slate-900 border border-slate-800 p-4 rounded-2xl text-white text-sm focus:border-blue-500 outline-none transition-all"></div>`;
                    const f = "f1";
                    if(currentSezonData[f]) {
                        let grupeDeAfisat = Object.keys(currentSezonData[f]).sort();
                        html += `<div class="grid grid-cols-2 gap-4">`;
                        grupeDeAfisat.forEach(gk => {
                            html += `<div onclick="nav('grupa', '${gk}', '${f}')" class="bg-slate-900 p-8 rounded-[2rem] border border-slate-800 text-center cursor-pointer hover:border-blue-500 transition-all shadow-lg"><div class="text-[10px] font-black text-slate-500 uppercase">Grupa</div><div class="text-3xl font-black text-white italic">${gk}</div></div>`;
                        });
                        html += `</div>`;
                    }
                }
            } else if(state.pagina === "grupa") {
                html += `<button onclick="nav('home')" class="bg-green-600 text-white px-8 py-4 rounded-2xl font-black uppercase text-[10px] mb-8 shadow-lg flex items-center gap-2">← Înapoi</button>`;
                const g = currentSezonData[state.faza][state.idGrupa], c = calculeazaClasament(g), top2 = c.slice(0, 2).map(x => x.nume);
                html += `<div class="text-center mb-6"><h3 class="text-2xl font-black italic uppercase text-white">Grupa ${state.idGrupa}</h3></div>
                <div class="bg-slate-900 p-6 rounded-[2rem] mb-12 border border-slate-800 shadow-2xl"><table class="w-full text-[11px] font-bold border-separate border-spacing-y-2">
                    <tr class="text-slate-500 uppercase tracking-widest"><th class="text-left px-2">Jucător</th><th class="text-center">V</th><th class="text-center">C</th><th class="text-right px-2">P</th></tr>
                    ${c.map(x => `<tr class="bg-black/20 rounded-xl"><td class="py-4 px-3 uppercase italic ${top2.includes(x.nume) ? 'text-green-500' : ''}">${x.nume}</td><td class="text-center text-blue-500 font-black">${x.victorii}</td><td class="text-center">${x.castigate}</td><td class="text-right px-3 text-slate-500">${x.pierdute}</td></tr>`).join('')}
                </table></div>`;
                g.participanti.forEach(j => {
                    const meciuri = g.meciuri.filter(m => m.p1 === j || m.p2 === j);
                    html += `<div class="mb-10"><h4 class="text-[11px] font-black uppercase mb-4 ml-2 tracking-widest text-slate-500">${j}</h4>`;
                    meciuri.forEach(m => {
                        const adv = m.p1 === j ? m.p2 : m.p1;
                        const s1 = m.p1 === j ? m.s1t : m.s2t; const s2 = m.p1 === j ? m.s2t : m.s1t;
                        const r1 = m.p1 === j ? m.s1r : m.s2r; const r2 = m.p1 === j ? m.s2r : m.s1r;
                        html += `<div class="bg-slate-900/50 p-5 rounded-2xl mb-3 flex justify-between items-center border border-white/5 shadow-lg">
                            <div class="text-[10px] font-black uppercase italic">${adv}</div>
                            <div class="flex gap-4">
                                <button onclick="updateScorMeci('${state.faza}','${m.id}','t','${m.p1}','${m.p2}', '${j}')" class="bg-black border border-slate-800 px-4 py-2 rounded-xl text-xs font-black min-w-[65px] uppercase">T: ${s1}-${s2}</button>
                                <button onclick="updateScorMeci('${state.faza}','${m.id}','r','${m.p1}','${m.p2}', '${j}')" class="bg-black border border-slate-800 px-4 py-2 rounded-xl text-xs font-black min-w-[65px] uppercase">R: ${r1}-${r2}</button>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                });
            }
            root.innerHTML = html + `</div>`;
            document.getElementById('auth-ui').innerHTML = userLogat ? `<div class="flex items-center gap-2"><span>${curataNume(userLogat.displayName)}</span><button onclick="logout()" class="text-red-500 ml-2">Iesire</button></div>` : '';
        }

        onAuthStateChanged(auth, u => { 
            userLogat = u; 
            onSnapshot(doc(db, "setari", "turnee"), s => { if(s.exists()) globalData = s.data(); render(); }); 
            onSnapshot(doc(db, "sezoane", `JOKER_2`), s => { if(s.exists()) currentSezonData = s.data(); render(); }); 
        });
    </script>
</head>
<body class="bg-black text-slate-300 font-sans tracking-tight mb-20">
    <div id="app"></div>
</body>
</html>
